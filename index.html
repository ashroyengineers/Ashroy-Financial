<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ashroy Architects & Engineers â€“ Financial Dashboard</title>
  <link rel="icon" href="https://i.imgur.com/12REMj2.jpeg" type="image/jpeg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #1a56db;
      --primary-light: #e1e8ff;
      --secondary: #0e9f6e;
      --secondary-light: #def7ec;
      --accent: #9061f9;
      --accent-light: #edebfe;
      --gray: #6b7280;
      --gray-light: #f3f4f6;
      --dark: #111827;
      --sidebar-width: 280px;
      --header-height: 70px;
      --global-header-height: 100px;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --primary: #3b82f6;
      --primary-light: #1e3a8a;
      --secondary: #10b981;
      --secondary-light: #064e3b;
      --accent: #8b5cf6;
      --accent-light: #4c1d95;
      --gray: #9ca3af;
      --gray-light: #374151;
      --dark: #f9fafb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Hind Siliguri', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    [data-theme="dark"] body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }

    /* Loading Animation */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Enhanced Glass Card Effect */
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 20px 40px rgba(31, 38, 135, 0.15);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .glass-card {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .glass-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 30px 60px rgba(31, 38, 135, 0.25);
    }

    /* Enhanced Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(135deg, #1a56db 0%, #0e9f6e 100%);
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
      transition: all 0.3s ease;
      padding-top: var(--header-height);
      box-shadow: 5px 0 20px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] .sidebar {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }

    .sidebar-logo {
      position: absolute;
      top: 15px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar-logo-icon {
      width: 45px;
      height: 45px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease;
    }

    .sidebar-logo-icon:hover {
      transform: scale(1.1);
    }

    .sidebar-logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .sidebar-logo-text {
      font-size: 18px;
      font-weight: 700;
      color: white;
    }

    /* Enhanced Navigation Links */
    .nav-link {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .nav-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .nav-link:hover::before {
      left: 100%;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left-color: white;
      transform: translateX(5px);
    }

    .nav-link.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-left-color: white;
      font-weight: 600;
    }

    .nav-link i {
      margin-right: 12px;
      width: 24px;
      text-align: center;
      font-size: 18px;
      transition: transform 0.3s ease;
    }

    .nav-link:hover i {
      transform: scale(1.2);
    }

    /* Theme Toggle Button */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.3);
    }

    /* Enhanced Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 20px;
      transition: margin-left 0.3s;
      padding-top: var(--global-header-height);
      overflow-x: hidden;
    }

    #global-page-header {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 0 0 20px 20px;
      padding: 20px 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: left 0.3s;
    }

    [data-theme="dark"] #global-page-header {
      background: rgba(30, 41, 59, 0.95);
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      color: var(--gray);
      font-size: 16px;
    }

    /* Enhanced KPI Cards */
    .kpi-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      height: 100%;
      border: 1px solid rgba(255, 255, 255, 0.5);
      position: relative;
      overflow: hidden;
    }

    [data-theme="dark"] .kpi-card {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .kpi-card:hover::before {
      left: 100%;
    }

    .kpi-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
    }

    .kpi-icon {
      width: 50px;
      height: 50px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      font-size: 20px;
      transition: transform 0.3s ease;
    }

    .kpi-card:hover .kpi-icon {
      transform: scale(1.1) rotate(5deg);
    }

    .kpi-title {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 26px;
      font-weight: 700;
      line-height: 1.2;
    }

    /* Enhanced Chart Container */
    .chart-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      height: 100%;
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .chart-container {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chart-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
    }

    /* Enhanced Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      gap: 8px;
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #3b82f6);
      color: white;
      box-shadow: 0 4px 15px rgba(26, 86, 219, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(26, 86, 219, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary), #10b981);
      color: white;
      box-shadow: 0 4px 15px rgba(14, 159, 110, 0.3);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(14, 159, 110, 0.4);
    }

    /* Enhanced Form Elements */
    input, select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      transition: all 0.3s;
      font-size: 14px;
    }

    [data-theme="dark"] input,
    [data-theme="dark"] select {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(255, 255, 255, 0.1);
      color: var(--dark);
    }

    input:focus, select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 4px rgba(26, 86, 219, 0.1);
      transform: translateY(-2px);
    }

    /* Enhanced Tables */
    .table-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    [data-theme="dark"] .table-container {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Notification System */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--primary);
      z-index: 1002;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left-color: var(--secondary);
    }

    .notification.error {
      border-left-color: #f43f5e;
    }

    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Responsive Design Enhancements */
    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
        width: 85%;
        max-width: var(--sidebar-width);
        z-index: 1001;
      }

      .sidebar.open {
        transform: translateX(0);
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
      }

      .main-content {
        margin-left: 0;
        padding: 15px;
        padding-top: calc(var(--header-height) + 85px + 20px);
      }

      #global-page-header {
        left: 0;
        top: var(--header-height);
        height: auto;
        padding: 15px 20px;
      }

      .theme-toggle {
        top: 15px;
        right: 70px;
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
    }

    /* Mobile Header */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: linear-gradient(135deg, #1a56db 0%, #0e9f6e 100%);
      z-index: 1100;
      padding: 0 20px;
      align-items: center;
      justify-content: space-between;
    }

    [data-theme="dark"] .mobile-header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }

    @media (max-width: 992px) {
      .mobile-header {
        display: flex;
      }
    }

    .mobile-header .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-weight: 600;
    }

    .mobile-logo {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      overflow: hidden;
    }

    .mobile-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .hamburger {
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .hamburger:hover {
      transform: scale(1.1);
    }

    /* Color Classes */
    .received-bg { background: var(--secondary-light); color: var(--secondary); }
    .paid-bg { background: #fde8e8; color: #f05252; }
    .cash-bg { background: var(--primary-light); color: var(--primary); }
    .received-text { color: var(--secondary); }
    .paid-text { color: #f05252; }
    .cash-text { color: var(--primary); }

    /* Utility Classes */
    .hidden { display: none; }
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .mt-auto { margin-top: auto; }
    .text-center { text-align: center; }
    .mb-4 { margin-bottom: 16px; }
    .mb-6 { margin-bottom: 24px; }
    .p-4 { padding: 16px; }
    .p-6 { padding: 24px; }
    .gap-4 { gap: 16px; }
    .w-full { width: 100%; }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .grid-col-2 {
      grid-column: span 2;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .grid-col-2 {
        grid-column: span 1;
      }
      
      /* Mobile-specific improvements */
      .page-title {
        font-size: 22px;
      }
      
      .page-subtitle {
        font-size: 14px;
      }
      
      .chart-container {
        padding: 20px;
      }
      
      .chart-title {
        font-size: 18px;
      }
      
      .chart-wrapper {
        height: 280px;
      }
      
      .flex.justify-center.gap-4 {
        flex-direction: column;
        align-items: center;
      }
      
      .flex.justify-center.gap-4 > * {
        width: 100%;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      .action-btn {
        padding: 5px 8px;
      }
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in-left {
      animation: slideInLeft 0.5s ease-out;
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .slide-in-right {
      animation: slideInRight 0.5s ease-out;
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Enhanced Chart Styles */
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--dark);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .chart-wrapper {
      height: 320px;
      position: relative;
    }

    .chart-mode-buttons {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .chart-mode-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: var(--gray-light);
      color: var(--gray);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
      font-weight: 500;
    }

    .chart-mode-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 86, 219, 0.3);
    }

    .chart-mode-btn:hover {
      transform: translateY(-1px);
    }

    /* Form Enhancements */
    .form-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    [data-theme="dark"] .form-card {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--dark);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
      font-size: 14px;
    }

    .input-icon {
      position: relative;
    }

    .input-icon i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      transition: color 0.3s ease;
    }

    .input-icon input:focus + i,
    .input-icon select:focus + i {
      color: var(--primary);
    }

    .input-icon input,
    .input-icon select {
      padding-left: 48px;
    }

    /* Footer */
    footer {
      padding: 24px;
      text-align: center;
      color: var(--gray);
      font-size: 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      margin-top: auto;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
    }

    /* Success Message */
    #success-message {
      background: linear-gradient(135deg, var(--secondary-light), rgba(16, 185, 129, 0.1));
      border: 1px solid var(--secondary);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      text-align: center;
      color: var(--secondary);
      font-weight: 600;
    }

    /* Table Enhancements */
    .table-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .table-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--dark);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 700;
      text-align: left;
      padding: 12px 16px;
    }

    [data-theme="dark"] th {
      background: var(--primary-light);
      color: var(--dark);
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.05);
    }

    tr:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    /* Action Buttons */
    .action-btn {
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
    }

    .edit-btn {
      background: var(--primary-light);
      color: var(--primary);
    }

    .edit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 86, 219, 0.3);
    }

    .delete-btn {
      background: #fde8e8;
      color: #f05252;
    }

    .delete-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(240, 82, 82, 0.3);
    }
  </style>
</head>
<body class="antialiased min-h-screen" data-theme="light">
  
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Theme Toggle Button -->
  <button class="theme-toggle" id="theme-toggle">
    <i class="fas fa-moon" id="theme-icon"></i>
  </button>

  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="logo">
      <div class="mobile-logo">
        <img src="https://i.imgur.com/12REMj2.jpeg" alt="Ashroy Architects Logo">
      </div>
      <span>Ashroy Architects</span>
    </div>
    <div class="hamburger" id="hamburger">
      <i class="fas fa-bars"></i>
    </div>
  </div>

  <!-- Notification Container -->
  <div class="notification" id="notification">
    <div class="notification-content">
      <i class="fas fa-check-circle"></i>
      <span id="notification-text">Success!</span>
    </div>
  </div>
  
  <!-- Sidebar Navigation -->
  <aside class="sidebar slide-in-left" id="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">
        <img src="https://i.imgur.com/12REMj2.jpeg" alt="Ashroy Architects Logo">
      </div>
      <div class="sidebar-logo-text">Ashroy Architects</div>
    </div>
    
    <nav class="py-6">
      <a href="#" id="nav-dashboard" class="nav-link active">
        <i class="fas fa-chart-line"></i>
        Dashboard
      </a>
      <a href="#" id="nav-summary" class="nav-link">
        <i class="fas fa-poll"></i>
        Summary
      </a>
      <a href="#" id="nav-projects" class="nav-link">
        <i class="fas fa-folder-open"></i>
        Project Reports
      </a>
      <a href="#" id="nav-entry" class="nav-link">
        <i class="fas fa-plus-circle"></i>
        New Entry
      </a>
      <a href="#" id="nav-report" class="nav-link">
        <i class="fas fa-file-invoice"></i>
        Transaction Report
      </a>
      <a href="#" id="nav-export" class="nav-link">
        <i class="fas fa-download"></i>
        Export Data
      </a>
    </nav>
    
    <div class="sidebar-footer mt-auto">
      <p>&copy; <span id="current-year"></span> Ashroy Architects</p>
      <p>Financial Dashboard v3.0</p>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content fade-in" id="main-content">
    <!-- Global Fixed Header -->
    <div id="global-page-header">
      <h1 class="page-title" id="global-page-title">Financial Dashboard</h1>
      <p class="page-subtitle" id="global-page-subtitle">Here is a quick overview of your business's financial health</p>
    </div>

    
    <!-- Dashboard Section -->
    <section id="dashboard-section" class="fade-in">
      <div class="dashboard-grid">
        <div class="kpi-card slide-in-left">
          <div class="kpi-icon received-bg">
            <i class="fas fa-arrow-down"></i>
          </div>
          <div class="kpi-title">Total Received</div>
          <div class="kpi-value received-text" id="total-received">à§³0</div>
        </div>
        
        <div class="kpi-card slide-in-left" style="animation-delay: 0.1s;">
          <div class="kpi-icon paid-bg">
            <i class="fas fa-arrow-up"></i>
          </div>
          <div class="kpi-title">Total Paid</div>
          <div class="kpi-value paid-text" id="total-paid">à§³0</div>
        </div>
        
        <div class="kpi-card slide-in-left" style="animation-delay: 0.2s;">
          <div class="kpi-icon cash-bg">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="kpi-title">Cash on Hand</div>
          <div class="kpi-value cash-text" id="cash-in-hand">à§³0</div>
        </div>
      </div>
      
      <div class="chart-container mb-6 slide-in-right">
        <div class="chart-header">
          <h2 class="chart-title">Monthly Revenue Analytics</h2>
          <select id="year-filter" class="p-2 border rounded">
            <!-- Years will be populated by JS -->
          </select>
        </div>
        
        <p class="chart-description">Advanced analytics showing your monthly income, expenses, and profit trends for the selected year.</p>
        
        <div class="chart-wrapper">
          <canvas id="revenueChart"></canvas>
        </div>
        
        <div class="chart-mode-buttons">
          <button class="chart-mode-btn active" data-mode="line">
            <i class="fas fa-chart-line"></i> Line
          </button>
          <button class="chart-mode-btn" data-mode="bar">
            <i class="fas fa-chart-bar"></i> Bar
          </button>
          <button class="chart-mode-btn" data-mode="stacked">
            <i class="fas fa-layer-group"></i> Stacked
          </button>
        </div>
        
        <div class="flex gap-4 mt-6">
          <div class="flex-1 text-center p-4 glass-card">
            <div class="text-gray-500 mb-1 font-medium">Avg. Monthly Received</div>
            <div class="text-xl font-bold text-green-600" id="avg-received">à§³0</div>
          </div>
          <div class="flex-1 text-center p-4 glass-card">
            <div class="text-gray-500 mb-1 font-medium">Avg. Monthly Paid</div>
            <div class="text-xl font-bold text-red-500" id="avg-paid">à§³0</div>
          </div>
          <div class="flex-1 text-center p-4 glass-card">
            <div class="text-gray-500 mb-1 font-medium">Avg. Monthly Profit</div>
            <div class="text-xl font-bold text-blue-600" id="avg-profit">à§³0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Summary Section -->
    <section id="summary-section" class="hidden">
      <div class="chart-container mb-6">
        <div class="chart-header">
          <h2 class="chart-title">Financial Summary</h2>
          <div class="flex gap-2">
            <button class="btn btn-primary" id="refresh-summary">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        
        <div class="dashboard-grid mb-8">
          <div class="kpi-card">
            <div class="kpi-icon received-bg">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="kpi-title">This Month Received</div>
            <div class="kpi-value received-text" id="month-received">à§³0</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-icon paid-bg">
              <i class="fas fa-calendar-times"></i>
            </div>
            <div class="kpi-title">This Month Paid</div>
            <div class="kpi-value paid-text" id="month-paid">à§³0</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-icon cash-bg">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div class="kpi-title">This Month Profit</div>
            <div class="kpi-value cash-text" id="month-profit">à§³0</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass-card p-6">
            <h3 class="text-lg font-bold mb-4">Payment Type Distribution</h3>
            <div class="chart-wrapper" style="height: 250px;">
              <canvas id="paymentTypeChart"></canvas>
            </div>
            <p class="text-sm text-gray-500 mt-4">* Shows payment distribution for the current month</p>
          </div>
          
          <div class="glass-card p-6">
            <h3 class="text-lg font-bold mb-4">Recent Transactions</h3>
            <div class="space-y-3" id="recent-transactions">
              <!-- Recent transactions will be populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Projects Section -->
    <section id="projects-section" class="hidden">
      <div class="chart-container mb-6">
        <div class="form-group">
          <label for="project-search">Search Project</label>
          <div class="input-icon">
            <i class="fas fa-search"></i>
            <input type="text" id="project-search" class="w-full" placeholder="Type project name to search..." list="project-list">
          </div>
          <datalist id="project-list">
            <!-- Projects will be populated by JS -->
          </datalist>
        </div>
        
        <div id="project-details" class="hidden mt-8">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <i class="fas fa-folder text-blue-500 text-2xl"></i>
              <h2 class="text-xl font-bold" id="project-title">Project Name</h2>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-primary" id="project-export-csv">
                <i class="fas fa-file-csv"></i> CSV
              </button>
              <button class="btn btn-secondary" id="project-export-pdf">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
            </div>
          </div>
          
          <div class="dashboard-grid mb-8">
            <div class="kpi-card">
              <div class="kpi-icon received-bg">
                <i class="fas fa-arrow-down"></i>
              </div>
              <div class="kpi-title">Total Received</div>
              <div class="kpi-value received-text" id="project-total-received">à§³0</div>
            </div>
            
            <div class="kpi-card">
              <div class="kpi-icon received-bg">
                <i class="fas fa-pencil-ruler"></i>
              </div>
              <div class="kpi-title">Total Design Bill</div>
              <div class="kpi-value received-text" id="project-total-design-bill">à§³0</div>
            </div>
            
            <div class="kpi-card">
              <div class="kpi-icon received-bg">
                <i class="fas fa-hard-hat"></i>
              </div>
              <div class="kpi-title">Total Site Visit</div>
              <div class="kpi-value received-text" id="project-total-site-visit">à§³0</div>
            </div>
            
            <div class="kpi-card">
              <div class="kpi-icon paid-bg">
                <i class="fas fa-arrow-up"></i>
              </div>
              <div class="kpi-title">Total Paid</div>
              <div class="kpi-value paid-text" id="project-total-paid">à§³0</div>
            </div>
            
            <div class="kpi-card">
              <div class="kpi-icon cash-bg">
                <i class="fas fa-wallet"></i>
              </div>
              <div class="kpi-title">Cash on Hand</div>
              <div class="kpi-value cash-text" id="project-cash-in-hand">à§³0</div>
            </div>
          </div>
          
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Project Transactions</h3>
            </div>
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Payment Type</th>
                    <th>Paid To</th>
                    <th class="text-right">Received</th>
                    <th class="text-right">Paid</th>
                    <th class="text-right">Cash</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="project-transactions-body">
                  <!-- Transactions will be populated by JS -->
                </tbody>
                <tfoot id="project-totals-row" class="font-semibold bg-gray-50">
                  <!-- Totals will be populated by JS -->
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Entry Section -->
    <section id="entry-section" class="hidden">
      <div class="form-card">
        <h2 class="form-title">Add New Transaction</h2>
        <form id="entry-form">
          <input type="hidden" id="edit-id" value="">
          
          <div class="form-grid">
            <div class="form-group">
              <label for="entry-date">Transaction Date</label>
              <div class="input-icon">
                <i class="fas fa-calendar"></i>
                <input type="date" id="entry-date" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-project-type">Project Type</label>
              <div class="input-icon">
                <i class="fas fa-layer-group"></i>
                <select id="entry-project-type">
                  <option value="existing">Existing Project</option>
                  <option value="new">New Project</option>
                </select>
              </div>
            </div>
            
            <div class="form-group" id="existing-project-container">
              <label for="entry-project-select">Select Project</label>
              <div class="input-icon">
                <i class="fas fa-folder"></i>
                <input type="text" id="entry-project-select" list="entry-project-list" placeholder="Type project name or select">
              </div>
              <datalist id="entry-project-list">
                <!-- Projects will be populated by JS -->
              </datalist>
            </div>
            
            <div class="form-group hidden" id="new-project-container">
              <label for="entry-project-new">New Project Name</label>
              <div class="input-icon">
                <i class="fas fa-plus"></i>
                <input type="text" id="entry-project-new" placeholder="e.g. 45_New Project">
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-payment-type">Payment Type</label>
              <div class="input-icon">
                <i class="fas fa-credit-card"></i>
                <select id="entry-payment-type" required>
                  <option value="Design Bill">Design Bill</option>
                  <option value="Site Visit">Site Visit</option>
                  <option value="Other's">Other's</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-paid-to">Paid To (Optional)</label>
              <div class="input-icon">
                <i class="fas fa-user"></i>
                <input type="text" id="entry-paid-to" placeholder="Enter recipient name">
              </div>
            </div>
            
            <div class="form-group grid-col-2">
              <label for="entry-description">Description</label>
              <div class="input-icon">
                <i class="fas fa-file-alt"></i>
                <input type="text" id="entry-description" placeholder="Enter a brief description of the transaction">
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-received">Received Amount (BDT)</label>
              <div class="input-icon">
                <i class="fas fa-arrow-down"></i>
                <input type="number" id="entry-received" value="0" min="0" step="0.01">
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-paid">Paid Amount (BDT)</label>
              <div class="input-icon">
                <i class="fas fa-arrow-up"></i>
                <input type="number" id="entry-paid" value="0" min="0" step="0.01">
              </div>
            </div>
          </div>
          
          <div class="flex justify-center gap-4 mt-8">
            <button type="submit" class="btn btn-primary" id="submit-entry">
              <i class="fas fa-paper-plane"></i> Submit Transaction
            </button>
            
            <button type="button" class="btn btn-secondary hidden" id="cancel-edit">
              <i class="fas fa-times"></i> Cancel Edit
            </button>
          </div>
          
          <div id="success-message" class="hidden">
            <i class="fas fa-check-circle"></i>
            <span class="font-medium">Success!</span> Transaction has been saved successfully.
          </div>
        </form>
      </div>
    </section>
    
    <!-- Report Section -->
    <section id="report-section" class="hidden">
      <div class="form-card">
        <h2 class="form-title">Generate Transaction Report</h2>
        <div class="form-grid mb-6">
          <div class="form-group">
            <label for="report-from">From Date</label>
            <div class="input-icon">
              <i class="fas fa-calendar-alt"></i>
              <input type="date" id="report-from">
            </div>
          </div>
          <div class="form-group">
            <label for="report-to">To Date</label>
            <div class="input-icon">
              <i class="fas fa-calendar-check"></i>
              <input type="date" id="report-to">
            </div>
          </div>
        </div>
        
        <div class="flex justify-center gap-4">
          <button class="btn btn-primary" id="generate-report">
            <i class="fas fa-play-circle"></i> Generate Report
          </button>
          <button class="btn btn-secondary" id="last-five-transactions">
            <i class="fas fa-history"></i> Last 5 Transactions
          </button>
        </div>
        
        <div id="report-results" class="hidden mt-8">
          <div class="flex items-center justify-between mb-6">
            <h3 class="table-title">Transaction Report Results</h3>
            <div class="flex gap-2">
              <button class="btn btn-primary" id="download-csv">
                <i class="fas fa-file-csv"></i> Export CSV
              </button>
              <button class="btn btn-secondary" id="download-pdf">
                <i class="fas fa-file-pdf"></i> Export PDF
              </button>
            </div>
          </div>
          
          <div class="table-container">
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Payment Type</th>
                    <th>Paid To</th>
                    <th class="text-right">Received</th>
                    <th class="text-right">Paid</th>
                    <th class="text-right">Cash</th>
                  </tr>
                </thead>
                <tbody id="report-transactions-body">
                  <!-- Report transactions will be populated by JS -->
                </tbody>
                <tfoot id="report-totals-row" class="font-semibold bg-gray-50">
                  <!-- Report totals will be populated by JS -->
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Export Section -->
    <section id="export-section" class="hidden">
      <div class="form-card text-center">
        <div class="flex-center mb-6">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex-center text-white text-3xl">
            <i class="fas fa-download"></i>
          </div>
        </div>
        
        <h2 class="text-2xl font-bold mb-3">Export Financial Data</h2>
        <p class="text-gray-600 mb-8">Download complete financial records for backup, analysis, or reporting purposes</p>
        
        <div class="flex-center gap-6">
          <button class="btn btn-primary" id="export-all-csv">
            <i class="fas fa-file-csv"></i> Export All Data (CSV)
          </button>
          <button class="btn btn-secondary" id="export-all-pdf">
            <i class="fas fa-file-pdf"></i> Export All Data (PDF)
          </button>
        </div>

        <div class="mt-8 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl">
          <h3 class="text-lg font-semibold mb-4">Export Options</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="text-left">
              <h4 class="font-medium text-blue-600 mb-2">CSV Format</h4>
              <ul class="text-sm text-gray-600 space-y-1">
                <li>â€¢ Spreadsheet compatible</li>
                <li>â€¢ Easy data manipulation</li>
                <li>â€¢ Lightweight file size</li>
              </ul>
            </div>
            <div class="text-left">
              <h4 class="font-medium text-purple-600 mb-2">PDF Format</h4>
              <ul class="text-sm text-gray-600 space-y-1">
                <li>â€¢ Professional presentation</li>
                <li>â€¢ Print-ready format</li>
                <li>â€¢ Secure document sharing</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="mt-6 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-xl">
          <h3 class="text-lg font-semibold mb-4">Data Management</h3>
          <div class="flex flex-wrap gap-4 justify-center">
            <button class="btn btn-primary" id="backup-data">
              <i class="fas fa-shield-alt"></i> Backup Data
            </button>
            <button class="btn btn-secondary" id="sync-data">
              <i class="fas fa-sync-alt"></i> Sync Data
            </button>
            <button class="btn" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;" id="analytics-report">
              <i class="fas fa-chart-pie"></i> Analytics Report
            </button>
          </div>
        </div>
      </div>
    </section>
    
    <footer>
      <p>&copy; <span id="current-year-footer"></span> Ashroy Architects & Engineers. All rights reserved.</p>
      <p class="mt-2 text-sm">Enhanced Financial Dashboard with Advanced Analytics</p>
    </footer>
  </main>

  
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      // Initialize Supabase
      const SUPABASE_URL = 'https://fosbmomuhezvexcrkrke.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvc2Jtb211aGV6dmV4Y3JrcmtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NDIxNDUsImV4cCI6MjA2NjQxODE0NX0.XaU9i04LRkkTBW8QAvNVHkx-mIeypTdnGBGInq3mUb4';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      
      let transactions = [];
      let currentReportData = [];
      let currentProjectData = [];
      let currentChartType = 'line';
      let revenueChart;
      let paymentTypeChart;

      // Enhanced notification system
      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        
        notification.className = `notification ${type}`;
        notificationText.textContent = message;
        
        notification.classList.add('show');
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }

      // Theme management
      function initializeTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
      }

      function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
        
        showNotification(`Switched to ${newTheme} mode`, 'success');
      }

      function updateThemeIcon(theme) {
        const themeIcon = document.getElementById('theme-icon');
        themeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
      }

      // Loading management
      function hideLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        setTimeout(() => {
          loadingOverlay.style.opacity = '0';
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 500);
        }, 1000);
      }

      // Enhanced format functions
      function formatCurrency(amount, withSymbol = true) {
        const formattedNumber = new Intl.NumberFormat('en-US').format(Math.abs(amount));
        if (withSymbol) {
          return `à§³${formattedNumber}`;
        }
        return formattedNumber;
      }
      
      function formatDate(date) {
        if (!date || !(date instanceof Date)) return '';
        return new Intl.DateTimeFormat('en-GB', { 
          day: '2-digit', 
          month: 'short', 
          year: 'numeric' 
        }).format(date);
      }

      // Enhanced KPI updates with animations
      function updateKPIs() {
        const totalRec = transactions.reduce((s, t) => s + t.received, 0);
        const totalPaid = transactions.reduce((s, t) => s + t.paid, 0);
        const cash = totalRec - totalPaid;
        
        animateValue('total-received', totalRec, formatCurrency);
        animateValue('total-paid', totalPaid, formatCurrency);
        animateValue('cash-in-hand', cash, formatCurrency);
      }

      function animateValue(elementId, targetValue, formatter) {
        const element = document.getElementById(elementId);
        const startValue = 0;
        const duration = 1000;
        const startTime = performance.now();

        function updateValue(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          
          const currentValue = startValue + (targetValue - startValue) * easeOutQuart(progress);
          element.textContent = formatter(currentValue);
          
          if (progress < 1) {
            requestAnimationFrame(updateValue);
          }
        }
        
        requestAnimationFrame(updateValue);
      }

      function easeOutQuart(t) {
        return 1 - Math.pow(1 - t, 4);
      }

      // Enhanced transaction loading
      async function loadTransactions() {
        try {
          const { data, error } = await supabase
            .from('transactions')
            .select('*')
            .order('date', { ascending: true });

          if (error) {
            console.error('Error loading transactions:', error);
            showNotification('Error loading transactions', 'error');
            return [];
          }

          return data.map(t => ({
            id: t.id,
            date: new Date(t.date),
            description: t.description,
            type: t.type,
            paidTo: t.paid_to,
            received: t.received,
            paid: t.paid,
            cashInHand: t.cash_in_hand
          }));
        } catch (error) {
          console.error('Network error:', error);
          showNotification('Network error occurred', 'error');
          return [];
        }
      }

      // Enhanced year filter population
      function populateYearFilter() {
        const yearFilter = document.getElementById('year-filter');
        const years = [...new Set(transactions.map(t => t.date.getFullYear()))].sort((a, b) => b - a);
        
        if (years.length === 0) {
          years.push(new Date().getFullYear());
        }
        
        yearFilter.innerHTML = years.map(y => 
          `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`
        ).join('');
        
        yearFilter.addEventListener('change', () => updateChart(currentChartType));
      }

      // Enhanced chart updates with better animations
      function updateChart(type = 'line') {
        currentChartType = type;
        const selYear = +document.getElementById('year-filter').value;
        const monthlyRec = Array(12).fill(0);
        const monthlyPaid = Array(12).fill(0);
        const monthsWithData = new Set();
        
        transactions.forEach(t => {
          if (t.date.getFullYear() === selYear) {
            const m = t.date.getMonth();
            monthlyRec[m] += t.received;
            monthlyPaid[m] += t.paid;
            monthsWithData.add(m);
          }
        });
        
        const profitData = monthlyRec.map((r, i) => r - monthlyPaid[i]);
        const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        const numMonthsWithData = monthsWithData.size > 0 ? monthsWithData.size : 1;
        const totalYearlyRec = monthlyRec.reduce((a, b) => a + b, 0);
        const totalYearlyPaid = monthlyPaid.reduce((a, b) => a + b, 0);
        const totalYearlyProfit = profitData.reduce((a, b) => a + b, 0);

        const avgRec = totalYearlyRec / numMonthsWithData;
        const avgPaid = totalYearlyPaid / numMonthsWithData;
        const avgProfit = totalYearlyProfit / numMonthsWithData;
        
        animateValue('avg-received', avgRec, formatCurrency);
        animateValue('avg-paid', avgPaid, formatCurrency);
        animateValue('avg-profit', avgProfit, formatCurrency);
        
        const ctx = document.getElementById('revenueChart').getContext('2d');
        
        // Update active button state with animation
        document.querySelectorAll('.chart-mode-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.mode === type);
        });
        
        // Destroy existing chart if it exists
        if (revenueChart) revenueChart.destroy();
        
        let datasets;
        let options = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          animation: {
            duration: 1000,
            easing: 'easeInOutQuart'
          },
          scales: {
            y: { 
              beginAtZero: true, 
              grid: { 
                color: 'rgba(0,0,0,0.05)',
                drawBorder: false
              },
              ticks: {
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            },
            x: { 
              grid: { display: false },
              ticks: {
                font: { weight: 'bold' }
              }
            }
          },
          plugins: {
            legend: { 
              position: 'top', 
              labels: { 
                usePointStyle: true, 
                padding: 20, 
                font: { size: 14, weight: 'bold' }
              } 
            },
            tooltip: {
              backgroundColor: 'rgba(17,24,39,0.95)',
              titleFont: { size: 16, weight: 'bold' },
              bodyFont: { size: 14 },
              cornerRadius: 12,
              displayColors: true,
              callbacks: { 
                label: ctx => `${ctx.dataset.label || ''}: ${formatCurrency(ctx.parsed.y)}`
              }
            }
          }
        };
        
        if (type === 'bar') {
          datasets = [
            {
              label: 'Total Received',
              data: monthlyRec,
              backgroundColor: 'rgba(16, 185, 129, 0.8)',
              borderColor: '#10B981',
              borderWidth: 2,
              borderRadius: 8,
            },
            {
              label: 'Total Paid',
              data: monthlyPaid,
              backgroundColor: 'rgba(244, 63, 94, 0.8)',
              borderColor: '#F43F5E',
              borderWidth: 2,
              borderRadius: 8,
            },
            {
              label: 'Profit',
              data: profitData,
              backgroundColor: 'rgba(59, 130, 246, 0.8)',
              borderColor: '#3B82F6',
              borderWidth: 2,
              borderRadius: 8,
            }
          ];
          options.type = 'bar';
        } 
        else if (type === 'stacked') {
          datasets = [
            {
              label: 'Total Received',
              data: monthlyRec,
              backgroundColor: 'rgba(16, 185, 129, 0.8)',
              borderColor: '#10B981',
              borderWidth: 2,
              borderRadius: 8,
            },
            {
              label: 'Total Paid',
              data: monthlyPaid,
              backgroundColor: 'rgba(244, 63, 94, 0.8)',
              borderColor: '#F43F5E',
              borderWidth: 2,
              borderRadius: 8,
            }
          ];
          options.type = 'bar';
          options.scales.x = { stacked: true };
          options.scales.y = { stacked: true };
        } 
        else { // Line chart
          datasets = [
            {
              label: 'Total Received',
              data: monthlyRec,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 4,
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#10B981',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 3,
              pointRadius: 6,
              pointHoverRadius: 8,
            },
            {
              label: 'Total Paid',
              data: monthlyPaid,
              borderColor: '#F43F5E',
              backgroundColor: 'rgba(244, 63, 94, 0.1)',
              borderWidth: 4,
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#F43F5E',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 3,
              pointRadius: 6,
              pointHoverRadius: 8,
            },
            {
              label: 'Profit',
              data: profitData,
              borderColor: '#3B82F6',
              backgroundColor: 'transparent',
              borderDash: [8, 4],
              borderWidth: 3,
              tension: 0.4,
              fill: false,
              pointBackgroundColor: '#3B82F6',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 3,
              pointRadius: 6,
              pointHoverRadius: 8,
            }
          ];
          options.type = 'line';
        }
        
        const data = { labels, datasets };
        revenueChart = new Chart(ctx, { type: options.type, data, options });
      }

      // Enhanced summary section
      function updateSummarySection() {
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        
        const monthlyTransactions = transactions.filter(t => 
          t.date.getMonth() === currentMonth && t.date.getFullYear() === currentYear
        );
        
        const monthReceived = monthlyTransactions.reduce((s, t) => s + t.received, 0);
        const monthPaid = monthlyTransactions.reduce((s, t) => s + t.paid, 0);
        const monthProfit = monthReceived - monthPaid;
        
        animateValue('month-received', monthReceived, formatCurrency);
        animateValue('month-paid', monthPaid, formatCurrency);
        animateValue('month-profit', monthProfit, formatCurrency);
        
        updatePaymentTypeChart();
        updateRecentTransactions();
      }

      function updatePaymentTypeChart() {
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        
        // Filter transactions for current month only
        const monthlyTransactions = transactions.filter(t => 
          t.date.getMonth() === currentMonth && t.date.getFullYear() === currentYear
        );
        
        const paymentTypes = {};
        monthlyTransactions.forEach(t => {
          if (t.received > 0) {
            paymentTypes[t.type] = (paymentTypes[t.type] || 0) + t.received;
          }
        });
        
        const ctx = document.getElementById('paymentTypeChart').getContext('2d');
        
        if (paymentTypeChart) paymentTypeChart.destroy();
        
        paymentTypeChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(paymentTypes),
            datasets: [{
              data: Object.values(paymentTypes),
              backgroundColor: [
                '#10B981',
                '#3B82F6', 
                '#F59E0B',
                '#EF4444',
                '#8B5CF6'
              ],
              borderWidth: 3,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 1000,
              easing: 'easeInOutQuart'
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  font: { size: 12, weight: 'bold' }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(17,24,39,0.95)',
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 13 },
                cornerRadius: 8,
                callbacks: {
                  label: function(context) {
                    return `${context.label}: ${formatCurrency(context.parsed)}`;
                  }
                }
              }
            }
          }
        });
      }

      function updateRecentTransactions() {
        const recentTransactions = transactions
          .sort((a, b) => b.date - a.date)
          .slice(0, 5);
        
        const container = document.getElementById('recent-transactions');
        container.innerHTML = recentTransactions.map(t => `
          <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
            <div>
              <div class="font-medium text-sm">${t.description}</div>
              <div class="text-xs text-gray-500">${formatDate(t.date)}</div>
            </div>
            <div class="text-right">
              <div class="font-bold ${t.received > 0 ? 'text-green-600' : 'text-red-500'}">
                ${t.received > 0 ? '+' : '-'}${formatCurrency(Math.max(t.received, t.paid))}
              </div>
              <div class="text-xs text-gray-500">${t.type}</div>
            </div>
          </div>
        `).join('');
      }

      // Enhanced navigation
      function setupNavigation() {
        const sections = ['dashboard', 'summary', 'projects', 'entry', 'report', 'export'];
        const navLinks = sections.map(s => document.getElementById(`nav-${s}`));
        const sectionElements = sections.map(s => document.getElementById(`${s}-section`));
        
        const pageHeaders = {
          dashboard: { title: 'Financial Dashboard', subtitle: 'Comprehensive overview of your business financial health' },
          summary: { title: 'Financial Summary', subtitle: 'Detailed analysis and insights of your financial data' },
          projects: { title: 'Project Reports', subtitle: 'Individual project financial tracking and analysis' },
          entry: { title: 'New Transaction', subtitle: 'Add new financial transactions to your records' },
          report: { title: 'Transaction Reports', subtitle: 'Generate detailed reports for specific date ranges' },
          export: { title: 'Export Data', subtitle: 'Download your financial data in various formats' }
        };

        navLinks.forEach((link, index) => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Update active nav link
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            
            // Hide all sections
            sectionElements.forEach(s => s.classList.add("hidden"));
            
            // Hide any open modals (like analytics report)
            const openModals = document.querySelectorAll(".fixed.inset-0");
            openModals.forEach(modal => modal.remove());

            // Show selected section with animation
            const targetSection = sectionElements[index];
            targetSection.classList.remove("hidden");
            targetSection.classList.add("fade-in");
            
            // Update page header
            const section = sections[index];
            document.getElementById('global-page-title').textContent = pageHeaders[section].title;
            document.getElementById('global-page-subtitle').textContent = pageHeaders[section].subtitle;
            
            // Close mobile sidebar
            document.getElementById('sidebar').classList.remove('open');
            
            // Update section-specific data
            if (section === 'summary') {
              updateSummarySection();
            }
          });
        });
      }

      // Enhanced mobile menu
      function setupMobileMenu() {
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.getElementById('sidebar');
        
        hamburger.addEventListener('click', () => {
          sidebar.classList.toggle('open');
        });
        
        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
          if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
            sidebar.classList.remove('open');
          }
        });
      }

      // Enhanced form handling
      async function setupFormHandling() {
        const form = document.getElementById('entry-form');
        const projectTypeSelect = document.getElementById('entry-project-type');
        const existingProjectContainer = document.getElementById('existing-project-container');
        const newProjectContainer = document.getElementById('new-project-container');
        
        projectTypeSelect.addEventListener('change', () => {
          if (projectTypeSelect.value === 'new') {
            existingProjectContainer.classList.add('hidden');
            newProjectContainer.classList.remove('hidden');
          } else {
            existingProjectContainer.classList.remove('hidden');
            newProjectContainer.classList.add('hidden');
          }
        });
        
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          await handleFormSubmission();
        });
      }

      async function handleFormSubmission() {
        const formData = {
          date: document.getElementById('entry-date').value,
          description: document.getElementById('entry-description').value,
          type: document.getElementById('entry-payment-type').value,
          paid_to: document.getElementById('entry-paid-to').value,
          received: parseFloat(document.getElementById('entry-received').value) || 0,
          paid: parseFloat(document.getElementById('entry-paid').value) || 0
        };
        
        // Calculate cash in hand
        const totalReceived = transactions.reduce((s, t) => s + t.received, 0) + formData.received;
        const totalPaid = transactions.reduce((s, t) => s + t.paid, 0) + formData.paid;
        formData.cash_in_hand = totalReceived - totalPaid;
        
        try {
          const { data, error } = await supabase
            .from('transactions')
            .insert([formData])
            .select();
          
          if (error) {
            console.error('Error saving transaction:', error);
            showNotification('Error saving transaction', 'error');
            return;
          }
          
          showNotification('Transaction saved successfully!', 'success');
          
          // Reset form
          document.getElementById('entry-form').reset();
          document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
          
          // Reload data
          await initializeData();
          
        } catch (error) {
          console.error('Network error:', error);
          showNotification('Network error occurred', 'error');
        }
      }

      // Enhanced project search with advanced filtering
      function setupProjectSearch() {
        const projectSearch = document.getElementById('project-search');
        const projectDetails = document.getElementById('project-details');
        const projectExportCSV = document.getElementById('project-export-csv');
        const projectExportPDF = document.getElementById('project-export-pdf');
        
        // Advanced search with debouncing
        let searchTimeout;
        projectSearch.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length > 0) {
              const matchingTransactions = transactions.filter(t => 
                t.description.toLowerCase().includes(searchTerm) ||
                t.type.toLowerCase().includes(searchTerm) ||
                (t.paidTo && t.paidTo.toLowerCase().includes(searchTerm))
              );
              
              if (matchingTransactions.length > 0) {
                displayProjectDetails(searchTerm, matchingTransactions);
                projectDetails.classList.remove('hidden');
                showNotification(`Found ${matchingTransactions.length} matching transactions`, 'success');
              } else {
                projectDetails.classList.add('hidden');
                showNotification('No matching transactions found', 'info');
              }
            } else {
              projectDetails.classList.add('hidden');
            }
          }, 300);
        });

        // Add keyboard shortcuts
        projectSearch.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            projectSearch.value = '';
            projectDetails.classList.add('hidden');
          }
        });
        
        // Export CSV
        projectExportCSV.addEventListener('click', () => {
          if (currentProjectData.length === 0) {
            showNotification('No project data to export', 'error');
            return;
          }
          exportToCSV(currentProjectData, `project-${document.getElementById('project-title').textContent}-transactions`);
        });
        
        // Export PDF
        projectExportPDF.addEventListener('click', () => {
          if (currentProjectData.length === 0) {
            showNotification('No project data to export', 'error');
            return;
          }
          exportToPDF(currentProjectData, `project-${document.getElementById('project-title').textContent}-transactions`);
        });
      }

      function displayProjectDetails(projectName, projectTransactions) {
        currentProjectData = projectTransactions;
        
        document.getElementById('project-title').textContent = projectName;
        
        const totalReceived = projectTransactions.reduce((s, t) => s + t.received, 0);
        const totalPaid = projectTransactions.reduce((s, t) => s + t.paid, 0);
        const designBill = projectTransactions.filter(t => t.type === 'Design Bill').reduce((s, t) => s + t.received, 0);
        const siteVisit = projectTransactions.filter(t => t.type === 'Site Visit').reduce((s, t) => s + t.received, 0);
        const cashInHand = totalReceived - totalPaid;
        
        document.getElementById('project-total-received').textContent = formatCurrency(totalReceived);
        document.getElementById('project-total-paid').textContent = formatCurrency(totalPaid);
        document.getElementById('project-total-design-bill').textContent = formatCurrency(designBill);
        document.getElementById('project-total-site-visit').textContent = formatCurrency(siteVisit);
        document.getElementById('project-cash-in-hand').textContent = formatCurrency(cashInHand);
        
        // Update project transactions table
        const tbody = document.getElementById('project-transactions-body');
        tbody.innerHTML = projectTransactions.map(t => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td>${formatDate(t.date)}</td>
            <td>${t.description}</td>
            <td><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${t.type}</span></td>
            <td>${t.paidTo || '-'}</td>
            <td class="text-right font-medium text-green-600">${formatCurrency(t.received)}</td>
            <td class="text-right font-medium text-red-500">${formatCurrency(t.paid)}</td>
            <td class="text-right font-medium">${formatCurrency(t.cashInHand)}</td>
            <td class="text-center">
              <button class="action-btn edit-btn" onclick="editTransaction(${t.id})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete-btn ml-1" onclick="deleteTransaction(${t.id})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }

      // Enhanced report generation
      function setupReportGeneration() {
        document.getElementById('generate-report').addEventListener('click', generateDateRangeReport);
        document.getElementById('last-five-transactions').addEventListener('click', generateLastFiveReport);
      }

      function generateDateRangeReport() {
        const fromDate = new Date(document.getElementById('report-from').value);
        const toDate = new Date(document.getElementById('report-to').value);
        
        if (!fromDate || !toDate) {
          showNotification('Please select both from and to dates', 'error');
          return;
        }
        
        const filteredTransactions = transactions.filter(t => 
          t.date >= fromDate && t.date <= toDate
        );
        
        displayReportResults(filteredTransactions);
      }

      function generateLastFiveReport() {
        const lastFive = transactions
          .sort((a, b) => b.date - a.date)
          .slice(0, 5);
        
        displayReportResults(lastFive);
      }

      function displayReportResults(reportTransactions) {
        currentReportData = reportTransactions;
        
        const tbody = document.getElementById('report-transactions-body');
        tbody.innerHTML = reportTransactions.map(t => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td>${formatDate(t.date)}</td>
            <td>${t.description}</td>
            <td><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${t.type}</span></td>
            <td>${t.paidTo || '-'}</td>
            <td class="text-right font-medium text-green-600">${formatCurrency(t.received)}</td>
            <td class="text-right font-medium text-red-500">${formatCurrency(t.paid)}</td>
            <td class="text-right font-medium">${formatCurrency(t.cashInHand)}</td>
          </tr>
        `).join('');
        
        // Update totals
        const totalReceived = reportTransactions.reduce((s, t) => s + t.received, 0);
        const totalPaid = reportTransactions.reduce((s, t) => s + t.paid, 0);
        const finalCash = totalReceived - totalPaid;
        
        const tfoot = document.getElementById('report-totals-row');
        tfoot.innerHTML = `
          <tr class="bg-gray-100 font-bold">
            <td colspan="4" class="text-right">TOTALS:</td>
            <td class="text-right text-green-600">${formatCurrency(totalReceived)}</td>
            <td class="text-right text-red-500">${formatCurrency(totalPaid)}</td>
            <td class="text-right text-blue-600">${formatCurrency(finalCash)}</td>
          </tr>
        `;
        
        document.getElementById('report-results').classList.remove('hidden');
        showNotification(`Report generated with ${reportTransactions.length} transactions`, 'success');
      }

      // Enhanced export functionality
      function setupExportFunctionality() {
        document.getElementById('download-csv').addEventListener('click', () => exportToCSV(currentReportData));
        document.getElementById('download-pdf').addEventListener('click', () => exportToPDF(currentReportData));
        document.getElementById('export-all-csv').addEventListener('click', () => exportToCSV(transactions));
        document.getElementById('export-all-pdf').addEventListener('click', () => exportToPDF(transactions));
        
        // New advanced features
        document.getElementById('backup-data').addEventListener('click', backupData);
        document.getElementById('sync-data').addEventListener('click', syncData);
        document.getElementById('analytics-report').addEventListener('click', generateAnalyticsReport);
      }

      // Data backup functionality
      function backupData() {
        const backupData = {
          timestamp: new Date().toISOString(),
          version: '3.0',
          transactions: transactions,
          metadata: {
            totalTransactions: transactions.length,
            dateRange: {
              from: transactions.length > 0 ? Math.min(...transactions.map(t => t.date.getTime())) : null,
              to: transactions.length > 0 ? Math.max(...transactions.map(t => t.date.getTime())) : null
            }
          }
        };
        
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ashroy-financial-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showNotification('Data backup created successfully!', 'success');
      }

      // Data synchronization
      async function syncData() {
        showNotification('Syncing data with Supabase...', 'info');
        
        try {
          const freshData = await loadTransactions();
          const oldCount = transactions.length;
          transactions = freshData;
          
          updateKPIs();
          populateYearFilter();
          updateChart();
          populateProjectLists();
          
          const newCount = transactions.length;
          const difference = newCount - oldCount;
          
          if (difference > 0) {
            showNotification(`Sync complete! ${difference} new transactions found.`, 'success');
          } else if (difference < 0) {
            showNotification(`Sync complete! ${Math.abs(difference)} transactions removed.`, 'success');
          } else {
            showNotification('Sync complete! Data is up to date.', 'success');
          }
        } catch (error) {
          showNotification('Sync failed. Please try again.', 'error');
        }
      }

      // Advanced analytics report
      function generateAnalyticsReport() {
        if (transactions.length === 0) {
          showNotification('No data available for analytics', 'error');
          return;
        }

        const analytics = calculateAdvancedAnalytics();
        displayAnalyticsModal(analytics);
      }

      function calculateAdvancedAnalytics() {
        const totalReceived = transactions.reduce((s, t) => s + t.received, 0);
        const totalPaid = transactions.reduce((s, t) => s + t.paid, 0);
        const netProfit = totalReceived - totalPaid;
        
        // Monthly trends
        const monthlyData = {};
        transactions.forEach(t => {
          const monthKey = `${t.date.getFullYear()}-${String(t.date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { received: 0, paid: 0, count: 0 };
          }
          monthlyData[monthKey].received += t.received;
          monthlyData[monthKey].paid += t.paid;
          monthlyData[monthKey].count += 1;
        });

        // Payment type analysis
        const paymentTypes = {};
        transactions.forEach(t => {
          if (!paymentTypes[t.type]) {
            paymentTypes[t.type] = { received: 0, paid: 0, count: 0 };
          }
          paymentTypes[t.type].received += t.received;
          paymentTypes[t.type].paid += t.paid;
          paymentTypes[t.type].count += 1;
        });

        // Growth analysis
        const months = Object.keys(monthlyData).sort();
        const growthRate = months.length > 1 ? 
          ((monthlyData[months[months.length - 1]].received - monthlyData[months[0]].received) / monthlyData[months[0]].received * 100) : 0;

        return {
          summary: {
            totalReceived,
            totalPaid,
            netProfit,
            profitMargin: totalReceived > 0 ? (netProfit / totalReceived * 100) : 0,
            transactionCount: transactions.length,
            averageTransaction: totalReceived / transactions.length,
            growthRate
          },
          monthlyData,
          paymentTypes,
          topProjects: getTopProjects(),
          insights: generateInsights(totalReceived, totalPaid, netProfit, growthRate)
        };
      }

      function getTopProjects() {
        const projects = {};
        transactions.forEach(t => {
          if (!projects[t.description]) {
            projects[t.description] = { received: 0, paid: 0, count: 0 };
          }
          projects[t.description].received += t.received;
          projects[t.description].paid += t.paid;
          projects[t.description].count += 1;
        });

        return Object.entries(projects)
          .map(([name, data]) => ({ name, ...data, profit: data.received - data.paid }))
          .sort((a, b) => b.profit - a.profit)
          .slice(0, 5);
      }

      function generateInsights(totalReceived, totalPaid, netProfit, growthRate) {
        const insights = [];
        
        if (netProfit > 0) {
          insights.push({ type: 'positive', text: `Your business is profitable with a net profit of ${formatCurrency(netProfit)}.` });
        } else {
          insights.push({ type: 'warning', text: `Your business has a net loss of ${formatCurrency(Math.abs(netProfit))}. Consider reviewing expenses.` });
        }

        if (growthRate > 10) {
          insights.push({ type: 'positive', text: `Excellent growth rate of ${growthRate.toFixed(1)}% indicates strong business expansion.` });
        } else if (growthRate < -10) {
          insights.push({ type: 'warning', text: `Declining revenue trend of ${growthRate.toFixed(1)}% requires attention.` });
        }

        const avgTransaction = totalReceived / transactions.length;
        if (avgTransaction > 50000) {
          insights.push({ type: 'info', text: `High average transaction value of ${formatCurrency(avgTransaction)} indicates premium projects.` });
        }

        return insights;
      }

      function displayAnalyticsModal(analytics) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
          <div class="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">Advanced Analytics Report</h2>
              <button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="this.closest('.fixed').remove()">Ã—</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <div class="bg-gradient-to-r from-green-100 to-green-200 p-4 rounded-lg">
                <div class="text-green-800 font-semibold">Total Revenue</div>
                <div class="text-2xl font-bold text-green-900">${formatCurrency(analytics.summary.totalReceived)}</div>
              </div>
              <div class="bg-gradient-to-r from-red-100 to-red-200 p-4 rounded-lg">
                <div class="text-red-800 font-semibold">Total Expenses</div>
                <div class="text-2xl font-bold text-red-900">${formatCurrency(analytics.summary.totalPaid)}</div>
              </div>
              <div class="bg-gradient-to-r from-blue-100 to-blue-200 p-4 rounded-lg">
                <div class="text-blue-800 font-semibold">Net Profit</div>
                <div class="text-2xl font-bold text-blue-900">${formatCurrency(analytics.summary.netProfit)}</div>
              </div>
              <div class="bg-gradient-to-r from-purple-100 to-purple-200 p-4 rounded-lg">
                <div class="text-purple-800 font-semibold">Profit Margin</div>
                <div class="text-2xl font-bold text-purple-900">${analytics.summary.profitMargin.toFixed(1)}%</div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Top Projects by Profit</h3>
                ${analytics.topProjects.map(project => `
                  <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="font-medium">${project.name}</span>
                    <span class="text-green-600 font-bold">${formatCurrency(project.profit)}</span>
                  </div>
                `).join('')}
              </div>
              
              <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Payment Type Analysis</h3>
                ${Object.entries(analytics.paymentTypes).map(([type, data]) => `
                  <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="font-medium">${type}</span>
                    <span class="text-blue-600 font-bold">${formatCurrency(data.received)}</span>
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-3">Business Insights</h3>
              ${analytics.insights.map(insight => `
                <div class="flex items-start gap-2 mb-2">
                  <i class="fas ${insight.type === 'positive' ? 'fa-check-circle text-green-500' : 
                    insight.type === 'warning' ? 'fa-exclamation-triangle text-yellow-500' : 
                    'fa-info-circle text-blue-500'} mt-1"></i>
                  <span class="text-gray-700">${insight.text}</span>
                </div>
              `).join('')}
            </div>

            <div class="flex justify-center mt-6">
              <button class="btn btn-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Print Report
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        showNotification('Analytics report generated successfully!', 'success');
      }

      function exportToCSV(data, filenamePrefix = 'financial-report') {
        const headers = ['Date', 'Description', 'Payment Type', 'Paid To', 'Received', 'Paid', 'Cash in Hand'];
        const csvContent = [
          headers.join(','),
          ...data.map(t => [
            formatDate(t.date),
            `"${t.description}"`,
            t.type,
            t.paidTo || '',
            t.received,
            t.paid,
            t.cashInHand
          ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filenamePrefix}-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showNotification('CSV file downloaded successfully', 'success');
      }

      function exportToPDF(data, filenamePrefix = 'financial-report') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(20);
        doc.text('Ashroy Architects & Engineers', 20, 20);
        doc.setFontSize(16);
        doc.text('Financial Report', 20, 30);
        doc.setFontSize(12);
        doc.text(`Generated on: ${formatDate(new Date())}`, 20, 40);
        
        // Prepare table data
        const tableData = data.map(t => [
          formatDate(t.date),
          t.description,
          t.type,
          t.paidTo || '',
          formatCurrency(t.received, false),
          formatCurrency(t.paid, false),
          formatCurrency(t.cashInHand, false)
        ]);
        
        // Add table
        doc.autoTable({
          head: [['Date', 'Description', 'Type', 'Paid To', 'Received', 'Paid', 'Cash']],
          body: tableData,
          startY: 50,
          styles: { fontSize: 8 },
          headStyles: { fillColor: [26, 86, 219] }
        });
        
        doc.save(`${filenamePrefix}-${new Date().toISOString().split('T')[0]}.pdf`);
        showNotification('PDF file downloaded successfully', 'success');
      }

      // Enhanced chart mode buttons
      function setupChartModeButtons() {
        document.querySelectorAll('.chart-mode-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            updateChart(btn.dataset.mode);
          });
        });
      }

      // Initialize data and UI
      async function initializeData() {
        transactions = await loadTransactions();
        updateKPIs();
        populateYearFilter();
        updateChart();
        populateProjectLists();
      }

      function populateProjectLists() {
        const projects = [...new Set(transactions.map(t => t.description))];
        
        const projectList = document.getElementById('project-list');
        const entryProjectList = document.getElementById('entry-project-list');
        
        const projectOptions = projects.map(p => `<option value="${p}">`).join('');
        
        projectList.innerHTML = projectOptions;
        entryProjectList.innerHTML = projectOptions;
      }

      // Set current year
      function setCurrentYear() {
        const currentYear = new Date().getFullYear();
        document.getElementById('current-year').textContent = currentYear;
        document.getElementById('current-year-footer').textContent = currentYear;
      }

      // Set default date
      function setDefaultDate() {
        document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
      }

      // Initialize everything
      async function initialize() {
        initializeTheme();
        setCurrentYear();
        setDefaultDate();
        setupNavigation();
        setupMobileMenu();
        setupFormHandling();
        setupProjectSearch();
        setupReportGeneration();
        setupExportFunctionality();
        setupChartModeButtons();
        
        // Theme toggle event
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        
        // Initialize data
        await initializeData();
        
        // Hide loading screen
        hideLoading();
        
        showNotification('Dashboard loaded successfully!', 'success');
      }

      // Global functions for inline event handlers
      window.editTransaction = function(id) {
        showNotification('Edit functionality coming soon!', 'info');
      };

      window.deleteTransaction = function(id) {
        if (confirm('Are you sure you want to delete this transaction?')) {
          showNotification('Delete functionality coming soon!', 'info');
        }
      };

      // Start the application
      initialize();
    });
  </script>
</body>
</html>
