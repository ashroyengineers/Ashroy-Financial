<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ashroy Architects & Engineers – Financial Dashboard</title>
  <link rel="icon" href="https://i.imgur.com/12REMj2.jpeg" type="image/jpeg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #1a56db;         /* Indigo */
      --primary-light: #e1e8ff;
      --secondary: #0e9f6e;       /* Green */
      --secondary-light: #def7ec;
      --accent: #9061f9;          /* Purple */
      --accent-light: #edebfe;
      --gray: #6b7280;
      --gray-light: #f3f4f6;
      --dark: #111827;
      --sidebar-width: 250px;
      --header-height: 70px;
      --global-header-height: 100px;
    }
    body {
      font-family: 'Hind Siliguri', sans-serif;
      background: linear-gradient(135deg, #f0f4f8 0%, #e6f0fa 100%);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }
    
    /* --- SIDEBAR STYLES --- */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(135deg, #1a56db 0%, #0e9f6e 100%);
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
      transition: all 0.3s ease;
      padding-top: var(--header-height);
    }
    
    .sidebar-logo {
      position: absolute;
      top: 15px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .sidebar-logo-icon {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .sidebar-logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .sidebar-logo-text {
      font-size: 18px;
      font-weight: 600;
      color: white;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      font-weight: 500;
    }
    
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left-color: white;
    }
    
    .nav-link.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left-color: white;
      font-weight: 600;
    }
    
    .nav-link i {
      margin-right: 12px;
      width: 24px;
      text-align: center;
      font-size: 18px;
    }
    
    .sidebar-footer {
      padding: 20px;
      text-align: center;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: auto;
    }
    
    /* --- MAIN CONTENT --- */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 20px;
      transition: margin-left 0.3s;
      padding-top: var(--global-header-height);
      overflow-x: hidden; /* Prevent horizontal scroll */
    }
    
    #global-page-header {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      z-index: 100;
      background: white;
      border-radius: 0 0 16px 16px;
      padding: 15px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      animation: none;
      transition: left 0.3s;
    }
    
    @media (max-width: 992px) {
      #global-page-header {
        left: 0;
      }
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 8px;
    }
    
    .page-subtitle {
      color: var(--gray);
      font-size: 16px;
    }
    
    /* --- KPI CARDS --- */
    .kpi-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 100%;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .kpi-icon {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      font-size: 18px;
    }
    
    .kpi-title {
      font-size: 13px;
      color: var(--gray);
      margin-bottom: 6px;
    }
    
    .kpi-value {
      font-size: 22px;
      font-weight: 600;
    }
    
    .received-bg { background: var(--secondary-light); color: var(--secondary); }
    .paid-bg { background: #fde8e8; color: #f05252; }
    .cash-bg { background: var(--primary-light); color: var(--primary); }
    
    .received-text { color: var(--secondary); }
    .paid-text { color: #f05252; }
    .cash-text { color: var(--primary); }
    
    /* --- CHARTS --- */
    .chart-container {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      height: 100%;
    }
    
    @media (max-width: 768px) {
      .chart-container {
        padding: 15px;
      }
    }
    
    @media (max-width: 576px) {
      .chart-container {
        padding: 12px;
      }
      
      canvas {
        max-width: 100%;
        height: auto !important;
      }
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .chart-wrapper {
      height: 280px;
      position: relative;
    }
    
    .chart-description {
      font-size: 14px;
      color: var(--gray);
      margin: 10px 0 15px;
    }
    
    .chart-mode-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .chart-mode-btn {
      padding: 6px 12px;
      border-radius: 6px;
      background: var(--gray-light);
      color: var(--gray);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .chart-mode-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* --- RESPONSIVE --- */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: linear-gradient(135deg, #1a56db 0%, #0e9f6e 100%);
      z-index: 1100;
      padding: 0 20px;
      align-items: center;
      justify-content: space-between;
    }
    
    .mobile-header .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-weight: 600;
    }
    
    .mobile-logo {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      overflow: hidden;
    }
    
    .mobile-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .hamburger {
      color: white;
      font-size: 24px;
      cursor: pointer;
    }
    
    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
        width: 80%;
        max-width: var(--sidebar-width);
        z-index: 1001; /* Ensure sidebar appears above other content */
      }
      
      .sidebar.open {
        transform: translateX(0);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      }
      
      .main-content {
        margin-left: 0;
        padding: 15px;
        padding-top: calc(var(--header-height) + 85px + 20px);
      }
      
      .mobile-header {
        display: flex;
      }
      
      #global-page-header {
        left: 0;
        top: var(--header-height);
        height: 85px;
        padding: 15px 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
    }
    
    /* --- GRID LAYOUT --- */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .grid-col-2 {
      grid-column: span 2;
    }
    
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .grid-col-2 {
        grid-column: span 1;
      }
      
      .kpi-card {
        padding: 12px;
      }
      
      .page-title {
        font-size: 20px;
        margin-bottom: 6px;
      }
      
      .page-subtitle {
        font-size: 14px;
      }
      
      #global-page-header {
        padding: 12px 15px;
        height: 75px;
      }
      
      .main-content {
        padding-top: calc(var(--header-height) + 75px + 15px) !important;
      }
    }
    
    @media (max-width: 576px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .main-content {
        padding: 10px;
      }
      
      .kpi-card {
        padding: 10px;
      }
      
      .chart-container {
        overflow-x: auto;
      }
      
      .table-container {
        overflow-x: auto;
      }
    }
    
    /* --- TABLES --- */
    .table-container {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    @media (max-width: 768px) {
      .table-container {
        border-radius: 12px;
      }
      
      .table-header {
        padding: 12px;
      }
      
      .table-title {
        font-size: 16px;
      }
    }
    
    .table-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .table-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    th {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
      text-align: left;
      padding: 10px 16px;
    }
    
    td {
      padding: 10px 16px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    tr:nth-child(even) {
      background-color: var(--gray-light);
    }
    
    /* --- FORMS --- */
    .form-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    @media (max-width: 576px) {
      .form-card {
        padding: 15px;
        border-radius: 12px;
      }
    }
    
    .form-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--dark);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    
    @media (max-width: 768px) {
      .form-grid {
        gap: 12px;
      }
    }
    
    @media (max-width: 576px) {
      .form-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      #global-page-header {
        padding: 10px 15px;
        border-radius: 0 0 12px 12px;
        height: 70px;
      }
      
      .main-content {
        padding-top: calc(var(--header-height) + 70px + 10px) !important;
      }
      
      .tab-navigation {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        display: flex;
        padding-bottom: 5px;
      }
      
      .tab-btn {
        flex: 0 0 auto;
        white-space: nowrap;
      }
      
      .page-title {
        font-size: 20px;
        margin-bottom: 4px;
      }
      
      .page-subtitle {
        font-size: 14px;
      }
    }
    
    @media (max-width: 576px) {
      .form-group {
        margin-bottom: 12px;
      }
      
      .form-group label {
        margin-bottom: 4px;
        display: block;
      }
      
      input, select, textarea {
        padding: 8px 10px;
        font-size: 14px;
      }
    }
    
    .form-group {
      margin-bottom: 14px;
    }
    
    @media (max-width: 576px) {
      .form-group {
        margin-bottom: 10px;
      }
      
      input, select, textarea {
        font-size: 14px;
        padding: 8px 10px;
      }
      
      label {
        font-size: 14px;
        margin-bottom: 3px;
      }
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--dark);
      font-size: 14px;
    }
    
    input, select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    input:focus, select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
    }
    
    .input-icon {
      position: relative;
    }
    
    .input-icon i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    
    .input-icon input, 
    .input-icon select {
      padding-left: 40px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      gap: 8px;
      font-size: 14px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #0e40af;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-secondary:hover {
      background: #0a7c53;
      transform: translateY(-2px);
    }
    
    .btn-danger {
      background: #f05252;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c53030;
      transform: translateY(-2px);
    }
    
    .action-btn {
      padding: 5px 8px;
      border-radius: 6px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    
    @media (max-width: 576px) {
      .action-btn {
        padding: 4px 6px;
        font-size: 12px;
      }
    }
    
    .edit-btn {
      background: var(--primary-light);
      color: var(--primary);
    }
    
    .delete-btn {
      background: #fde8e8;
      color: #f05252;
    }
    
    /* --- UTILITY CLASSES --- */
    .hidden {
      display: none;
    }
    
    .flex-center {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mt-auto {
      margin-top: auto;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mb-4 {
      margin-bottom: 16px;
    }
    
    .mb-6 {
      margin-bottom: 24px;
    }
    
    .p-4 {
      padding: 16px;
    }
    
    .p-6 {
      padding: 24px;
    }
    
    .gap-4 {
      gap: 16px;
    }
    
    .w-full {
      width: 100%;
    }
    
    /* --- FOOTER --- */
    footer {
      padding: 20px;
      text-align: center;
      color: var(--gray);
      font-size: 14px;
      border-top: 1px solid var(--gray-light);
      margin-top: auto;
    }
    
    /* --- ANIMATIONS --- */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tab-content {
      animation: fadeIn 0.5s ease-in-out;
    }
  </style>
</head>
<body class="antialiased min-h-screen">
  
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="logo">
      <div class="mobile-logo">
        <img src="https://i.imgur.com/12REMj2.jpeg" alt="Ashroy Architects Logo">
      </div>
      <span>Ashroy Architects</span>
    </div>
    <div class="hamburger" id="hamburger">
      <i class="fas fa-bars"></i>
    </div>
  </div>
  
  <!-- Sidebar Navigation -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">
        <img src="https://i.imgur.com/12REMj2.jpeg" alt="Ashroy Architects Logo">
      </div>
      <div class="sidebar-logo-text">Ashroy Architects</div>
    </div>
    
    <nav class="py-6">
      <a href="#" id="nav-dashboard" class="nav-link active">
        <i class="fas fa-chart-line"></i>
        Dashboard
      </a>
      <a href="#" id="nav-summary" class="nav-link">
        <i class="fas fa-poll"></i>
        Summary
      </a>
      <a href="#" id="nav-projects" class="nav-link">
        <i class="fas fa-folder-open"></i>
        Project Reports
      </a>
      <a href="#" id="nav-entry" class="nav-link">
        <i class="fas fa-plus-circle"></i>
        New Entry
      </a>
      <a href="#" id="nav-report" class="nav-link">
        <i class="fas fa-file-invoice"></i>
        Transaction Report
      </a>
      <a href="#" id="nav-export" class="nav-link">
        <i class="fas fa-download"></i>
        Export Data
      </a>
    </nav>
    
    <div class="sidebar-footer mt-auto">
      <p>&copy; <span id="current-year"></span> Ashroy Architects</p>
      <p>Financial Dashboard v2.0</p>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content" id="main-content">
    <!-- Global Fixed Header -->
    <div id="global-page-header">
      <h1 class="page-title" id="global-page-title">Financial Dashboard</h1>
      <p class="page-subtitle" id="global-page-subtitle">Here is a quick overview of your business's financial health</p>
    </div>
    
    <!-- Dashboard Section -->
    <section id="dashboard-section">
      <div class="dashboard-grid">
        <div class="kpi-card">
          <div class="kpi-icon received-bg">
            <i class="fas fa-arrow-down"></i>
          </div>
          <div class="kpi-title">Total Received</div>
          <div class="kpi-value received-text" id="total-received">৳0</div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-icon paid-bg">
            <i class="fas fa-arrow-up"></i>
          </div>
          <div class="kpi-title">Total Paid</div>
          <div class="kpi-value paid-text" id="total-paid">৳0</div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-icon cash-bg">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="kpi-title">Cash on Hand</div>
          <div class="kpi-value cash-text" id="cash-in-hand">৳0</div>
        </div>
      </div>
      
      <div class="chart-container mb-6">
        <div class="chart-header">
          <h2 class="chart-title">Monthly Revenue</h2>
          <select id="year-filter" class="p-2 border rounded">
            <!-- Years will be populated by JS -->
          </select>
        </div>
        
        <p class="chart-description">This chart shows your monthly income, expenses, and profit for the selected year.</p>
        
        <div class="chart-wrapper">
          <canvas id="revenueChart"></canvas>
        </div>
        
        <div class="chart-mode-buttons">
          <button class="chart-mode-btn active" data-mode="line">Line</button>
          <button class="chart-mode-btn" data-mode="bar">Bar</button>
          <button class="chart-mode-btn" data-mode="stacked">Stacked</button>
        </div>
        
        <div class="flex gap-4 mt-6">
          <div class="flex-1 text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-gray-500 mb-1">Avg. Monthly Received</div>
            <div class="text-xl font-bold text-green-600" id="avg-received">৳0</div>
          </div>
          <div class="flex-1 text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-gray-500 mb-1">Avg. Monthly Paid</div>
            <div class="text-xl font-bold text-red-500" id="avg-paid">৳0</div>
          </div>
          <div class="flex-1 text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-gray-500 mb-1">Avg. Monthly Profit</div>
            <div class="text-xl font-bold text-blue-600" id="avg-profit">৳0</div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Projects Section -->
    <section id="projects-section" class="hidden">
      <div class="chart-container mb-6">
        <div class="form-group">
          <label for="project-search">Search Project</label>
          <div class="input-icon">
            <i class="fas fa-search"></i>
            <input type="text" id="project-search" class="w-full" placeholder="Type project name to search..." list="project-list">
          </div>
          <datalist id="project-list">
            <!-- Projects will be populated by JS -->
          </datalist>
        </div>
        
        <div id="project-details" class="hidden mt-8">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <i class="fas fa-folder text-blue-500 text-2xl"></i>
              <h2 class="text-xl font-bold" id="project-title">Project Name</h2>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-primary" id="project-export-csv">
                <i class="fas fa-file-csv"></i> CSV
              </button>
              <button class="btn btn-secondary" id="project-export-pdf">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
            </div>
          </div>
          
          <div class="dashboard-grid mb-8">
            <div class="kpi-card">
              <div class="kpi-icon received-bg">
                <i class="fas fa-arrow-down"></i>
              </div>
              <div class="kpi-title">Total Received</div>
              <div class="kpi-value received-text" id="project-total-received">৳0</div>
            </div>
            
            <div class="kpi-card">
              <div class="kpi-icon received-bg">
                <i class="fas fa-pencil-ruler"></i>
              </div>
              <div class="kpi-title">Total Design Bill</div>
              <div class="kpi-value received-text" id="project-total-design-bill">৳0</div>
            </div>
            
            <div class="kpi-card">
              <div class="kpi-icon received-bg">
                <i class="fas fa-hard-hat"></i>
              </div>
              <div class="kpi-title">Total Site Visit</div>
              <div class="kpi-value received-text" id="project-total-site-visit">৳0</div>
            </div>
            
            <div class="kpi-card">
              <div class="kpi-icon paid-bg">
                <i class="fas fa-arrow-up"></i>
              </div>
              <div class="kpi-title">Total Paid</div>
              <div class="kpi-value paid-text" id="project-total-paid">৳0</div>
            </div>
            
            <div class="kpi-card">
              <div class="kpi-icon cash-bg">
                <i class="fas fa-wallet"></i>
              </div>
              <div class="kpi-title">Cash on Hand</div>
              <div class="kpi-value cash-text" id="project-cash-in-hand">৳0</div>
            </div>
          </div>
          
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Transactions</h3>
            </div>
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Payment Type</th>
                    <th>Paid To</th>
                    <th class="text-right">Received</th>
                    <th class="text-right">Paid</th>
                    <th class="text-right">Cash</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="project-transactions-body">
                  <!-- Transactions will be populated by JS -->
                </tbody>
                <tfoot id="project-totals-row" class="font-semibold bg-gray-50">
                  <!-- Totals will be populated by JS -->
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Entry Section -->
    <section id="entry-section" class="hidden">
      <div class="form-card">
        <form id="entry-form">
          <input type="hidden" id="edit-id" value="">
          
          <div class="form-grid">
            <div class="form-group">
              <label for="entry-date">Date</label>
              <div class="input-icon">
                <i class="fas fa-calendar"></i>
                <input type="date" id="entry-date" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-project-type">Project Type</label>
              <select id="entry-project-type">
                <option value="existing">Existing Project</option>
                <option value="new">New Project</option>
              </select>
            </div>
            
            <div class="form-group" id="existing-project-container">
              <label for="entry-project-select">Select Project</label>
              <div class="input-icon">
                <i class="fas fa-folder"></i>
                <input type="text" id="entry-project-select" list="entry-project-list" placeholder="Type project name or select">
              </div>
              <datalist id="entry-project-list">
                <!-- Projects will be populated by JS -->
              </datalist>
            </div>
            
            <div class="form-group hidden" id="new-project-container">
              <label for="entry-project-new">New Project Name</label>
              <div class="input-icon">
                <i class="fas fa-plus"></i>
                <input type="text" id="entry-project-new" placeholder="e.g. 45_New Project">
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-payment-type">Payment Type</label>
              <div class="input-icon">
                <i class="fas fa-credit-card"></i>
                <select id="entry-payment-type" required>
                  <option value="Design Bill">Design Bill</option>
                  <option value="Site Visit">Site Visit</option>
                  <option value="Other's">Other's</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-paid-to">Paid To (Optional)</label>
              <div class="input-icon">
                <i class="fas fa-user"></i>
                <input type="text" id="entry-paid-to" placeholder="Enter recipient name">
              </div>
            </div>
            
            <div class="form-group grid-col-2">
              <label for="entry-description">Description</label>
              <div class="input-icon">
                <i class="fas fa-file-alt"></i>
                <input type="text" id="entry-description" placeholder="Enter a brief description of the transaction">
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-received">Received (BDT)</label>
              <div class="input-icon">
                <i class="fas fa-arrow-down"></i>
                <input type="number" id="entry-received" value="0" min="0">
              </div>
            </div>
            
            <div class="form-group">
              <label for="entry-paid">Paid (BDT)</label>
              <div class="input-icon">
                <i class="fas fa-arrow-up"></i>
                <input type="number" id="entry-paid" value="0" min="0">
              </div>
            </div>
          </div>
          
          <div class="flex justify-center gap-4 mt-8">
            <button type="submit" class="btn btn-primary" id="submit-entry">
              <i class="fas fa-paper-plane"></i> Submit Entry
            </button>
            
            <button type="button" class="btn btn-secondary hidden" id="cancel-edit">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
          
          <div id="success-message" class="hidden mt-6 p-4 bg-green-100 text-green-700 rounded text-center">
            <span class="font-medium">Success!</span> New transaction added.
          </div>
        </form>
      </div>
    </section>
    
    <!-- Report Section -->
    <section id="report-section" class="hidden">
      <div class="form-card">
        <div class="form-grid mb-6">
          <div class="form-group">
            <label for="report-from">From Date</label>
            <input type="date" id="report-from">
          </div>
          <div class="form-group">
            <label for="report-to">To Date</label>
            <input type="date" id="report-to">
          </div>
        </div>
        
        <div class="flex justify-center gap-4">
          <button class="btn btn-primary" id="generate-report">
            <i class="fas fa-play-circle"></i> Generate Report
          </button>
          <button class="btn btn-secondary" id="last-five-transactions">
            <i class="fas fa-history"></i> Last 5 Transactions
          </button>
        </div>
        
        <div id="report-results" class="hidden mt-8">
          <div class="flex items-center justify-between mb-6">
            <h3 class="table-title">Transactions</h3>
            <div class="flex gap-2">
              <button class="btn btn-primary" id="download-csv">
                <i class="fas fa-file-csv"></i> CSV
              </button>
              <button class="btn btn-secondary" id="download-pdf">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
            </div>
          </div>
          
          <div class="table-container">
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Payment Type</th>
                    <th>Paid To</th>
                    <th class="text-right">Received</th>
                    <th class="text-right">Paid</th>
                    <th class="text-right">Cash</th>
                  </tr>
                </thead>
                <tbody id="report-transactions-body">
                  <!-- Report transactions will be populated by JS -->
                </tbody>
                <tfoot id="report-totals-row" class="font-semibold bg-gray-50">
                  <!-- Report totals will be populated by JS -->
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Export Section -->
    <section id="export-section" class="hidden">
      <div class="form-card text-center">
        <div class="flex-center mb-6">
          <div class="w-16 h-16 rounded-full bg-blue-100 flex-center text-blue-600 text-2xl">
            <i class="fas fa-download"></i>
          </div>
        </div>
        
        <h2 class="text-xl font-semibold mb-2">Download Complete Financial Data</h2>
        <p class="text-gray-600 mb-8">Export all transactions and project data for record keeping or further analysis</p>
        
        <div class="flex-center gap-6">
          <button class="btn btn-primary" id="export-all-csv">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
          <button class="btn btn-secondary" id="export-all-pdf">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
        </div>
      </div>
    </section>
    
    <footer>
      <p>&copy; <span id="current-year-footer"></span> Ashroy Architects & Engineers. All rights reserved.</p>
    </footer>
  </main>
  
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      // Initialize Supabase
      const SUPABASE_URL = 'https://fosbmomuhezvexcrkrke.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvc2Jtb211aGV6dmV4Y3JrcmtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NDIxNDUsImV4cCI6MjA2NjQxODE0NX0.XaU9i04LRkkTBW8QAvNVHkx-mIeypTdnGBGInq3mUb4';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      
      let transactions = [];
      let currentReportData = [];
      let currentProjectData = [];
      let currentChartType = 'line';
      let revenueChart;

      const monthMap = {
        'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3,
        'May': 4, 'Jun': 5, 'Jul': 6, 'Aug': 7,
        'Sep': 8, 'Oct': 9, 'Nov': 10,'Dec': 11
      };
      
      // Format currency values
      function formatCurrency(amount, withSymbol = true) {
        const formattedNumber = new Intl.NumberFormat('en-US').format(amount);
        if (withSymbol) {
          return `৳${formattedNumber}`;
        }
        return formattedNumber;
      }
      
      // Format dates
      function formatDate(date) {
        if (!date || !(date instanceof Date)) return '';
        return new Intl.DateTimeFormat('en-GB', { day:'2-digit', month:'short', year:'numeric' }).format(date);
      }

      // Update KPIs
      function updateKPIs() {
        const totalRec = transactions.reduce((s,t)=>s+t.received, 0);
        const totalPaid= transactions.reduce((s,t)=>s+t.paid,    0);
        const cash     = totalRec - totalPaid;
        document.getElementById('total-received').textContent = formatCurrency(totalRec);
        document.getElementById('total-paid').textContent     = formatCurrency(totalPaid);
        document.getElementById('cash-in-hand').textContent   = formatCurrency(cash);
      }

      // Load transactions from Supabase
      async function loadTransactions() {
        const { data, error } = await supabase
          .from('transactions')
          .select('*')
          .order('date', { ascending: true });

        if (error) {
          console.error('Error loading transactions:', error);
          return [];
        }

        return data.map(t => ({
          id: t.id,
          date: new Date(t.date),
          description: t.description,
          type: t.type,
          paidTo: t.paid_to,
          received: t.received,
          paid: t.paid,
          cashInHand: t.cash_in_hand
        }));
      }

      // Populate year filter
      function populateYearFilter() {
        const yearFilter = document.getElementById('year-filter');
        const years = [...new Set(transactions.map(t=>t.date.getFullYear()))].sort((a,b)=>b-a);
        yearFilter.innerHTML = years.map(y => `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`).join('');
        yearFilter.addEventListener('change', () => updateChart(currentChartType));
      }

      function updateChart(type = 'line') {
        currentChartType = type;
        const selYear = +document.getElementById('year-filter').value;
        const monthlyRec = Array(12).fill(0), monthlyPaid = Array(12).fill(0);
        const monthsWithData = new Set();
        
        transactions.forEach(t => {
          if (t.date.getFullYear() === selYear) {
            const m = t.date.getMonth();
            monthlyRec[m] += t.received;
            monthlyPaid[m] += t.paid;
            monthsWithData.add(m);
          }
        });
        
        const profitData = monthlyRec.map((r,i) => r - monthlyPaid[i]);
        const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        
        const numMonthsWithData = monthsWithData.size > 0 ? monthsWithData.size : 1;
        const totalYearlyRec = monthlyRec.reduce((a, b) => a + b, 0);
        const totalYearlyPaid = monthlyPaid.reduce((a, b) => a + b, 0);
        const totalYearlyProfit = profitData.reduce((a, b) => a + b, 0);

        const avgRec = totalYearlyRec / numMonthsWithData;
        const avgPaid = totalYearlyPaid / numMonthsWithData;
        const avgProfit = totalYearlyProfit / numMonthsWithData;
        
        document.getElementById('avg-received').textContent = formatCurrency(avgRec);
        document.getElementById('avg-paid').textContent = formatCurrency(avgPaid);
        document.getElementById('avg-profit').textContent = formatCurrency(avgProfit);
        
        const ctx = document.getElementById('revenueChart').getContext('2d');
        
        // Update active button state
        document.querySelectorAll('.chart-mode-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.mode === type);
        });
        
        // Destroy existing chart if it exists
        if (revenueChart) revenueChart.destroy();
        
        let datasets;
        let options = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: { 
              beginAtZero: true, 
              grid: { color: 'rgba(0,0,0,0.05)' } 
            },
            x: { 
              grid: { display: false } 
            }
          },
          plugins: {
            legend: { 
              position: 'top', 
              labels: { 
                usePointStyle: true, 
                padding: 20, 
                font: { size: 14 } 
              } 
            },
            tooltip: {
              backgroundColor: 'rgba(17,24,39,0.9)',
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 14 },
              callbacks: { 
                label: ctx => `${ctx.dataset.label || ''}: ${formatCurrency(ctx.parsed.y)}` 
              }
            }
          }
        };
        
        if (type === 'bar') {
          datasets = [
            {
              label: 'Total Received',
              data: monthlyRec,
              backgroundColor: '#10B981',
              borderColor: '#10B981',
              borderWidth: 1,
            },
            {
              label: 'Total Paid',
              data: monthlyPaid,
              backgroundColor: '#F43F5E',
              borderColor: '#F43F5E',
              borderWidth: 1,
            },
            {
              label: 'Profit',
              data: profitData,
              backgroundColor: '#3B82F6',
              borderColor: '#3B82F6',
              borderWidth: 1,
            }
          ];
          options.type = 'bar';
        } 
        else if (type === 'stacked') {
          datasets = [
            {
              label: 'Total Received',
              data: monthlyRec,
              backgroundColor: '#10B981',
              borderColor: '#10B981',
              borderWidth: 1,
            },
            {
              label: 'Total Paid',
              data: monthlyPaid,
              backgroundColor: '#F43F5E',
              borderColor: '#F43F5E',
              borderWidth: 1,
            }
          ];
          options.type = 'bar';
          options.scales.x = { stacked: true };
          options.scales.y = { stacked: true };
        } 
        else { // Line chart
          datasets = [
            {
              label: 'Total Received',
              data: monthlyRec,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
            },
            {
              label: 'Total Paid',
              data: monthlyPaid,
              borderColor: '#F43F5E',
              backgroundColor: 'rgba(244, 63, 94, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
            },
            {
              label: 'Profit',
              data: profitData,
              borderColor: '#3B82F6',
              backgroundColor: 'transparent',
              borderDash: [5, 5],
              borderWidth: 2.5,
              tension: 0.4,
              fill: false,
            }
          ];
          options.type = 'line';
        }
        
        const data = { labels, datasets };
        
        revenueChart = new Chart(ctx, { type: options.type, data, options });
      }

      // Populate project selectors
      function populateProjectSelectors() {
        const names = [...new Set(transactions.map(t => t.description))].sort();
        
        const projectList = document.getElementById('project-list');
        projectList.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join('');
        
        const entryProjectList = document.getElementById('entry-project-list');
        entryProjectList.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join('');
      }

      // Show project details
      function showProjectDetails(name) {
        const details = document.getElementById('project-details');
        if (!name) {
          details.classList.add('hidden');
          return;
        }
        const filtered = transactions.filter(t=>t.description === name);
        if (filtered.length === 0) {
          details.classList.add('hidden');
          return;
        }
        
        currentProjectData = filtered;
        
        const totalRec = filtered.reduce((s,t)=>s+t.received,0);
        const totalPaid= filtered.reduce((s,t)=>s+t.paid,0);
        const cash     = totalRec - totalPaid;
        const totalDesignBill = filtered.filter(t => t.type === 'Design Bill').reduce((s, t) => s + t.received, 0);
        const totalSiteVisit = filtered.filter(t => t.type === 'Site Visit').reduce((s, t) => s + t.received, 0);

        document.getElementById('project-title').textContent = name;
        document.getElementById('project-total-received').textContent = formatCurrency(totalRec);
        document.getElementById('project-total-design-bill').textContent = formatCurrency(totalDesignBill);
        document.getElementById('project-total-site-visit').textContent = formatCurrency(totalSiteVisit);
        document.getElementById('project-total-paid').textContent    = formatCurrency(totalPaid);
        document.getElementById('project-cash-in-hand').textContent  = formatCurrency(cash);
        
        const tbody = document.getElementById('project-transactions-body');
        tbody.innerHTML = filtered
          .sort((a,b) => a.date - b.date)
          .map(t => `
            <tr class="border-b hover:bg-gray-50">
              <td class="py-3 px-4">${formatDate(t.date)}</td>
              <td class="py-3 px-4">${t.description}</td>
              <td class="py-3 px-4">${t.type}</td>
              <td class="py-3 px-4">${t.paidTo || '-'}</td>
              <td class="py-3 px-4 text-right text-green-600 font-medium">${formatCurrency(t.received)}</td>
              <td class="py-3 px-4 text-right text-red-500 font-medium">${formatCurrency(t.paid)}</td>
              <td class="py-3 px-4 text-right font-semibold ${t.cashInHand >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(t.cashInHand)}</td>
              <td class="py-3 px-4 text-center">
                <button class="action-btn edit edit-btn" data-id="${t.id}">
                  <i class="fas fa-edit mr-1"></i> Edit
                </button>
                <button class="action-btn delete delete-btn" data-id="${t.id}">
                  <i class="fas fa-trash mr-1"></i> Delete
                </button>
              </td>
            </tr>`).join('');
            
        const tfoot = document.getElementById('project-totals-row');
        tfoot.innerHTML = `
          <tr class="totals-row">
            <td colspan="4" class="text-right font-bold">Totals:</td>
            <td class="py-2 px-4 text-right text-green-600">${formatCurrency(totalRec)}</td>
            <td class="py-2 px-4 text-right text-red-500">${formatCurrency(totalPaid)}</td>
            <td class="py-2 px-4 text-right text-blue-600">${formatCurrency(cash)}</td>
            <td></td>
          </tr>
        `;
        
        details.classList.remove('hidden');
      }

      // Handle form submission
      async function handleFormSubmit(e) {
        e.preventDefault();
        const dateStr = document.getElementById('entry-date').value;
        const typeSel = document.getElementById('entry-project-type').value;
        let projectName = '';
        if (typeSel === 'existing') {
          projectName = document.getElementById('entry-project-select').value;
        } else {
          projectName = document.getElementById('entry-project-new').value.trim();
        }
        const paymentType = document.getElementById('entry-payment-type').value;
        const desc = document.getElementById('entry-description').value.trim();
        const rec = parseFloat(document.getElementById('entry-received').value) || 0;
        const paid = parseFloat(document.getElementById('entry-paid').value) || 0;
        const paidTo = document.getElementById('entry-paid-to').value.trim();
        const editId = document.getElementById('edit-id').value;
        
        if (!dateStr || !projectName || !paymentType) {
          alert('Please enter date, project name, and payment type.');
          return;
        }
        
        if (editId) {
          const { error } = await supabase
            .from('transactions')
            .update({
              date: new Date(dateStr),
              description: projectName,
              type: paymentType,
              paid_to: paidTo,
              received: rec,
              paid: paid
            })
            .eq('id', editId);
          
          if (error) {
            alert('Error updating transaction: ' + error.message);
            return;
          }
          
          const index = transactions.findIndex(t => t.id == editId);
          if (index !== -1) {
            transactions[index] = {
              ...transactions[index],
              date: new Date(dateStr),
              description: projectName,
              type: paymentType,
              paidTo: paidTo,
              received: rec,
              paid: paid,
              cashInHand: rec - paid
            };
          }
          
          document.getElementById('edit-id').value = '';
        } else {
          const { data: newTxn, error } = await supabase
            .from('transactions')
            .insert([{
              date: new Date(dateStr),
              description: projectName,
              type: paymentType,
              paid_to: paidTo,
              received: rec,
              paid: paid
            }])
            .select();
          
          if (error) {
            alert('Error adding transaction: ' + error.message);
            return;
          }
          
          if (newTxn && newTxn.length > 0) {
            const mappedTxn = {
              id: newTxn[0].id,
              date: new Date(newTxn[0].date),
              description: newTxn[0].description,
              type: newTxn[0].type,
              paidTo: newTxn[0].paid_to,
              received: newTxn[0].received,
              paid: newTxn[0].paid,
              cashInHand: newTxn[0].cash_in_hand
            };
            transactions.push(mappedTxn);
          }
        }
        
        document.getElementById('success-message').classList.remove('hidden');
        setTimeout(() => document.getElementById('success-message').classList.add('hidden'), 3000);
        document.getElementById('entry-form').reset();
        toggleEntryProjectType();
        updateAllViews();
      }

      function toggleEntryProjectType() {
        const mode = document.getElementById('entry-project-type').value;
        const existingDiv = document.getElementById('existing-project-container');
        const newDiv      = document.getElementById('new-project-container');
        if (mode === 'existing') {
          existingDiv.classList.remove('hidden');
          newDiv.classList.add('hidden');
          document.getElementById('entry-project-new').value = '';
        } else {
          existingDiv.classList.add('hidden');
          newDiv.classList.remove('hidden');
        }
      }
      
      function editTransaction(id) {
        const txn = transactions.find(t => t.id == id);
        if (!txn) return;
        
        switchTab('entry');
        
        document.getElementById('edit-id').value = txn.id;
        document.getElementById('entry-date').valueAsDate = txn.date;
        document.getElementById('entry-description').value = txn.description;
        document.getElementById('entry-payment-type').value = txn.type;
        document.getElementById('entry-paid-to').value = txn.paidTo || '';
        document.getElementById('entry-received').value = txn.received;
        document.getElementById('entry-paid').value = txn.paid;
        
        const names = [...new Set(transactions.map(t => t.description))];
        if (names.includes(txn.description)) {
          document.getElementById('entry-project-type').value = 'existing';
          document.getElementById('entry-project-select').value = txn.description;
          toggleEntryProjectType();
        } else {
          document.getElementById('entry-project-type').value = 'new';
          document.getElementById('entry-project-new').value = txn.description;
          toggleEntryProjectType();
        }
      }
      
      async function deleteTransaction(id) {
        if (confirm('Are you sure you want to delete this transaction?')) {
          const { error } = await supabase
            .from('transactions')
            .delete()
            .eq('id', id);
          
          if (error) {
            alert('Error deleting transaction: ' + error.message);
            return;
          }
          
          transactions = transactions.filter(t => t.id != id);
          updateAllViews();
        }
      }
      
      function displayReportData(data) {
        data.sort((a, b) => a.date - b.date);
        
        const tbody = document.getElementById('report-transactions-body');
        tbody.innerHTML = data.map(t => `
          <tr class="border-b hover:bg-gray-50">
            <td class="py-3 px-4">${formatDate(t.date)}</td>
            <td class="py-3 px-4">${t.description}</td>
            <td class="py-3 px-4">${t.type}</td>
            <td class="py-3 px-4">${t.paidTo || '-'}</td>
            <td class="py-3 px-4 text-right text-green-600 font-medium">${formatCurrency(t.received)}</td>
            <td class="py-3 px-4 text-right text-red-500 font-medium">${formatCurrency(t.paid)}</td>
            <td class="py-3 px-4 text-right font-semibold ${t.cashInHand >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(t.cashInHand)}</td>
          </tr>
        `).join('');
        
        const totalRec = data.reduce((sum, t) => sum + t.received, 0);
        const totalPaid = data.reduce((sum, t) => sum + t.paid, 0);
        const totalCash = totalRec - totalPaid;
        
        const tfoot = document.getElementById('report-totals-row');
        tfoot.innerHTML = `
          <tr class="totals-row">
            <td colspan="4" class="text-right font-bold">Totals:</td>
            <td class="py-2 px-4 text-right text-green-600">${formatCurrency(totalRec)}</td>
            <td class="py-2 px-4 text-right text-red-500">${formatCurrency(totalPaid)}</td>
            <td class="py-2 px-4 text-right text-blue-600">${formatCurrency(totalCash)}</td>
          </tr>
        `;
      }
      
      function generateReport() {
        const fromDateStr = document.getElementById('report-from').value;
        const toDateStr = document.getElementById('report-to').value;
        if (!fromDateStr || !toDateStr) {
          alert('Please select both dates.');
          return;
        }

        const fromDate = new Date(fromDateStr);
        const toDate = new Date(toDateStr);
        
        toDate.setHours(23, 59, 59, 999);
        
        const filtered = transactions.filter(t => {
          const tDate = t.date;
          return tDate >= fromDate && tDate <= toDate;
        });
        
        currentReportData = filtered;
        
        displayReportData(filtered);
        document.getElementById('report-results').classList.remove('hidden');
      }
      
      function showLastFiveTransactions() {
        const lastFive = [...transactions].sort((a, b) => b.date - a.date).slice(0, 5);
        currentReportData = lastFive;
        displayReportData(lastFive);
        document.getElementById('report-results').classList.remove('hidden');
      }
      
      function downloadCSV(data, filename, headerText = '') {
        const headers = ['Date', 'Description', 'Payment Type', 'Paid To', 'Received (BDT)', 'Paid (BDT)', 'Cash (BDT)'];
        const rows = data.map(t => [
          formatDate(t.date),
          t.description || '',
          t.type || '',
          t.paidTo || '',
          formatCurrency(t.received, false).replace(/৳/g, ''),
          formatCurrency(t.paid, false).replace(/৳/g, ''),
          formatCurrency(t.cashInHand, false).replace(/৳/g, '')
        ]);
        
        // Adding BOM for UTF-8 to help Excel open it correctly
        let csvContent = '\uFEFF';
        // Replace Bengali currency symbols in the header text
        const cleanHeaderText = headerText ? headerText.replace(/৳/g, 'BDT ') : '';
        csvContent += cleanHeaderText ? `${cleanHeaderText}\n\n` : '';
        csvContent += headers.join(',') + '\n';
        rows.forEach(row => {
          csvContent += row.join(',') + '\n';
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      function downloadPDF(data, title, filename, summaryLines = []) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Use Helvetica font which has better support for currency symbols
        doc.setFont('helvetica', 'normal');
        
        doc.setFontSize(18);
        doc.text("Ashroy Architects & Engineers", doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
        doc.setFontSize(14);
        doc.text(title, doc.internal.pageSize.getWidth() / 2, 24, { align: 'center' });

        let startY = 35;
        if (summaryLines.length > 0) {
            doc.setFontSize(10);
            summaryLines.forEach(line => {
                // Replace Bengali currency symbol with standard dollar sign for PDF reports
                const cleanedLine = line.replace(/৳/g, 'BDT ');
                doc.text(cleanedLine, 15, startY);
                startY += 6;
            });
        }
        
        const headers = [['Date', 'Description', 'Type', 'Paid To', 'Received', 'Paid', 'Cash']];
        
        const rows = data.map(t => [
          formatDate(t.date),
          t.description,
          t.type,
          t.paidTo || '',
          // Replace Bengali currency with BDT prefix for better compatibility
          formatCurrency(t.received, false).replace(/৳/g, ''),
          formatCurrency(t.paid, false).replace(/৳/g, ''),
          formatCurrency(t.cashInHand, false).replace(/৳/g, '')
        ]);
        
        doc.autoTable({
          head: headers,
          body: rows,
          startY: startY,
          theme: 'grid',
          headStyles: { 
            fillColor: [26, 86, 219], 
            textColor: 255, 
            fontStyle: 'bold', 
            font: 'helvetica',
            fontSize: 10
          },
          styles: { 
            fontSize: 9, 
            cellPadding: 2.5, 
            font: 'helvetica', 
            fontStyle: 'normal'
          },
          columnStyles: {
            4: { halign: 'right', cellWidth: 'auto', prefix: 'BDT ' },
            5: { halign: 'right', cellWidth: 'auto', prefix: 'BDT ' },
            6: { halign: 'right', cellWidth: 'auto', prefix: 'BDT ' }
          },
          didParseCell: function(data) {
            // Add BDT prefix to currency cells
            if (data.column.index >= 4 && data.column.index <= 6) {
              if (data.cell.raw !== '') {
                data.cell.text = ['BDT ' + data.cell.text];
              }
            }
          }
        });
        
        doc.save(filename);
      }
      
      function downloadAllData(format) {
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        const filename = `Ashroy_Financial_Data_${dateStr}`;
        const title = "Complete Financial Data Report";

        if (format === 'csv') {
          downloadCSV(transactions, `${filename}.csv`, `Ashroy Architects & Engineers\n${title}`);
        } else if (format === 'pdf') {
          downloadPDF(transactions, title, `${filename}.pdf`);
        }
      }

      // Tab navigation
      const navLinks = document.querySelectorAll('.nav-link');
      const sections = document.querySelectorAll('main > section');
      
      const tabTitles = {
        'dashboard': ['Financial Dashboard', 'Here is a quick overview of your business\'s financial health'],
        'summary': ['Financial Dashboard', 'Here is a quick overview of your business\'s financial health'],
        'projects': ['Project Reports', 'Select a project below to view its financial report'],
        'entry': ['Add New Transaction', 'Use this form to add a transaction for an existing or new project'],
        'report': ['Transaction Report', 'Generate a report of transactions between two dates'],
        'export': ['Export Data', 'Download all financial data in CSV or PDF format']
      };
      
      function switchTab(targetId) {
          let effectiveTarget = targetId === 'summary' ? 'dashboard' : targetId;
      
          navLinks.forEach(link => {
              const linkTarget = link.id.replace('nav-', '');
              link.classList.remove('active');
              
              if (effectiveTarget === 'dashboard' && (linkTarget === 'dashboard' || linkTarget === 'summary')) {
                  link.classList.add('active');
              } else if (linkTarget === effectiveTarget) {
                  link.classList.add('active');
              }
          });
      
          sections.forEach(sec => {
              if (sec.id === effectiveTarget + '-section') {
                  sec.classList.remove('hidden');
              } else {
                  sec.classList.add('hidden');
              }
          });
          
          // Update global header
          document.getElementById('global-page-title').textContent = tabTitles[effectiveTarget][0];
          document.getElementById('global-page-subtitle').textContent = tabTitles[effectiveTarget][1];
      }

      navLinks.forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const target = e.target.closest('a').id.replace('nav-', '');
          switchTab(target);
          document.getElementById('sidebar').classList.remove('open');
        });
      });

      // Initialize data and UI
      transactions = await loadTransactions();
      const currentYear = new Date().getFullYear();
      document.getElementById('current-year').textContent = currentYear;
      document.getElementById('current-year-footer').textContent = currentYear;
      switchTab('dashboard');
      populateYearFilter();
      updateKPIs();
      updateChart();
      populateProjectSelectors();
      
      // Toggle sidebar on mobile
      document.getElementById('hamburger').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('open');
      });
      
      // Close sidebar when clicking outside on mobile
      document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.getElementById('hamburger');
        const isClickInsideSidebar = sidebar.contains(e.target);
        const isClickInsideHamburger = hamburger.contains(e.target);
        
        if (!isClickInsideSidebar && !isClickInsideHamburger && sidebar.classList.contains('open')) {
          sidebar.classList.remove('open');
        }
      });

      document.getElementById('project-search').addEventListener('input', function(e) {
        showProjectDetails(e.target.value);
      });
      
      document.getElementById('project-export-csv').addEventListener('click', function() {
        if (currentProjectData.length === 0) return;
        const projectName = document.getElementById('project-title').textContent;
        const filename = `Ashroy_Project_${projectName.replace(/\s+/g, '_')}_Report.csv`;
        const title = `Ashroy Architects & Engineers\nProject Report: ${projectName}`;
        
        const totalRec = currentProjectData.reduce((s,t)=>s+t.received,0);
        const totalDesignBill = currentProjectData.filter(t=>t.type==='Design Bill').reduce((s,t)=>s+t.received,0);
        const totalSiteVisit = currentProjectData.filter(t=>t.type==='Site Visit').reduce((s,t)=>s+t.received,0);
        const totalPaid = currentProjectData.reduce((s,t)=>s+t.paid,0);
        const cashOnHand = totalRec - totalPaid;
        
        const summary = [
            `Total Received:,BDT ${formatCurrency(totalRec, false)}`,
            `Total Design Bill:,BDT ${formatCurrency(totalDesignBill, false)}`,
            `Total Site Visit:,BDT ${formatCurrency(totalSiteVisit, false)}`,
            `Total Paid:,BDT ${formatCurrency(totalPaid, false)}`,
            `Cash on Hand:,BDT ${formatCurrency(cashOnHand, false)}`
        ].join('\n');
        downloadCSV(currentProjectData, filename, `${title}\n\n${summary}`);
      });
      
      document.getElementById('project-export-pdf').addEventListener('click', function() {
        if (currentProjectData.length === 0) return;
        const projectName = document.getElementById('project-title').textContent;
        const filename = `Ashroy_Project_${projectName.replace(/\s+/g, '_')}_Report.pdf`;
        const title = `Project Report: ${projectName}`;
        
        const totalRec = currentProjectData.reduce((s,t)=>s+t.received,0);
        const totalDesignBill = currentProjectData.filter(t=>t.type==='Design Bill').reduce((s,t)=>s+t.received,0);
        const totalSiteVisit = currentProjectData.filter(t=>t.type==='Site Visit').reduce((s,t)=>s+t.received,0);
        const totalPaid = currentProjectData.reduce((s,t)=>s+t.paid,0);
        const cashOnHand = totalRec - totalPaid;
        
        const summary = [
            `Total Received: BDT ${formatCurrency(totalRec, false)}`,
            `Total Design Bill: BDT ${formatCurrency(totalDesignBill, false)}`,
            `Total Site Visit: BDT ${formatCurrency(totalSiteVisit, false)}`,
            `Total Paid: BDT ${formatCurrency(totalPaid, false)}`,
            `Cash on Hand: BDT ${formatCurrency(cashOnHand, false)}`
        ];
        downloadPDF(currentProjectData, title, filename, summary);
      });
      
      document.getElementById('generate-report').addEventListener('click', generateReport);
      
      document.getElementById('last-five-transactions').addEventListener('click', showLastFiveTransactions);
      
      document.getElementById('download-csv').addEventListener('click', function() {
        if (currentReportData.length === 0) return;
        const from = document.getElementById('report-from').value;
        const to = document.getElementById('report-to').value;
        const filename = `Ashroy_Transaction_Report_${from}_to_${to}.csv`;
        const title = `Ashroy Architects & Engineers\nTransaction Report (${from} to ${to})`;
        downloadCSV(currentReportData, filename, title);
      });
      
      document.getElementById('download-pdf').addEventListener('click', function() {
        if (currentReportData.length === 0) return;
        const from = document.getElementById('report-from').value;
        const to = document.getElementById('report-to').value;
        const title = `Transaction Report (${from} to ${to})`;
        const filename = `Ashroy_Transaction_Report_${from}_to_${to}.pdf`;
        downloadPDF(currentReportData, title, filename);
      });
      
      document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-btn')) {
          const id = e.target.closest('.edit-btn').dataset.id;
          editTransaction(id);
        }
        
        if (e.target.closest('.delete-btn')) {
          const id = e.target.closest('.delete-btn').dataset.id;
          deleteTransaction(id);
        }
        
        if (e.target.closest('.chart-mode-btn')) {
          const btn = e.target.closest('.chart-mode-btn');
          const mode = btn.dataset.mode;
          updateChart(mode);
        }
      });
      
      document.getElementById('cancel-edit').addEventListener('click', function() {
        document.getElementById('entry-form').reset();
        document.getElementById('edit-id').value = '';
        toggleEntryProjectType();
      });
      
      document.getElementById('export-all-csv').addEventListener('click', () => downloadAllData('csv'));
      document.getElementById('export-all-pdf').addEventListener('click', () => downloadAllData('pdf'));
      
      document.getElementById('entry-form').addEventListener('submit', handleFormSubmit);
      document.getElementById('entry-project-type').addEventListener('change', toggleEntryProjectType);

      function updateAllViews() {
        updateKPIs();
        populateYearFilter();
        updateChart(currentChartType);
        populateProjectSelectors();
        
        const projectTitle = document.getElementById('project-title').textContent;
        if (projectTitle && !document.getElementById('projects-section').classList.contains('hidden')) {
            const currentProjectName = document.getElementById('project-search').value;
            showProjectDetails(currentProjectName);
        }
      }
    });
  </script>
</body>
</html>
